(function(u,v){if(typeof Object.defineProperty!=='function'){Object.defineProperty=function(a,b,c){if('value'in c){a[b]=c.value}if('get'in c){a.__defineGetter__(b,c.get)}if('set'in c){a.__defineSetter__(b,c.set)}return a}}if(typeof Object.defineProperties!=='function'){Object.defineProperties=function(a,b){for(var c in b){if(b.hasOwnProperty(c)){Object.defineProperty(a,c,b[c])}}return a}}if(typeof Object.create!=='function'){Object.create=function(a,b){function F(){}F.prototype=a;var c=new F();if(b!=null){Object.defineProperties(c,b)}return c}}if(typeof Object.getPrototypeOf!=='function'){Object.getPrototypeOf=function(a){return a.__proto__}}if(typeof Function.prototype.bind!=='function'){Function.prototype.bind=function(b){var c=this;var d=Array.prototype.slice.call(arguments,1);var e=function(){};var f=function(){var a=d.concat(Array.prototype.slice.call(arguments));return c.apply(this instanceof e?this:b||u,a)};e.prototype=c.prototype;f.prototype=new e();return f}}u.getTime=(function(){var a;if(u.performance&&u.performance.now){a=Date.now();return function(){return a+u.performance.now()}}else if(u.performance&&u.performance.webkitNow){a=Date.now();return function(){return a+u.performance.webkitNow()}}else{return Date.now}}());u.requestAnimationFrame=u.requestAnimationFrame||u.mozRequestAnimationFrame||u.webkitRequestAnimationFrame||u.msRequestAnimationFrame||(function(){var c=u.getTime();var d=1000/60;return function(a){var b=setTimeout(function(){c=u.getTime();a(c)},Math.max(0,c+d-u.getTime()));return b}}());var z=function(e){if(e!=null){if(!(e instanceof Array)){e=Array.prototype.slice.call(arguments)}e=e.filter(function(a){return[a].join()})}(function include(a,b){var c=[],i,len;for(var d in a){if(a.hasOwnProperty(d)){if(typeof a[d]==='function'){u[d]=a[d]}else if(typeof a[d]==='object'&&a[d]!==null&&Object.getPrototypeOf(a[d])===Object.prototype){if(e==null){c.push(d)}else{i=e.indexOf(b+d);if(i!==-1){c.push(d);e.splice(i,1)}}}}}for(i=0,len=c.length;i<len;i++){include(a[c[i]],b+c[i]+'.')}}(z,''));if(z.Class.getInheritanceTree(u.Game).length<=z.Class.getInheritanceTree(u.Core).length){u.Game=u.Core}if(e!=null&&e.length){throw new Error('Cannot load module: '+e.join(', '));}};u.enchant=z;u.addEventListener("message",function(a,b){try{var c=JSON.parse(a.data);if(c.type==="event"){z.Core.instance.dispatchEvent(new z.Event(c.value))}else if(c.type==="debug"){switch(c.value){case"start":z.Core.instance.start();break;case"pause":z.Core.instance.pause();break;case"resume":z.Core.instance.resume();break;case"tick":z.Core.instance._tick();break;default:break}}}catch(e){}},false);z.Class=function(a,b){return z.Class.create(a,b)};z.Class.create=function(a,b){if(a==null&&b){throw new Error("superclass is undefined (enchant.Class.create)");}else if(a==null){throw new Error("definition is undefined (enchant.Class.create)");}if(arguments.length===0){return z.Class.create(Object,b)}else if(arguments.length===1&&typeof arguments[0]!=='function'){return z.Class.create(Object,arguments[0])}for(var c in b){if(b.hasOwnProperty(c)){if(typeof b[c]==='object'&&b[c]!==null&&Object.getPrototypeOf(b[c])===Object.prototype){if(!('enumerable'in b[c])){b[c].enumerable=true}}else{b[c]={value:b[c],enumerable:true,writable:true}}}}var d=function(){if(this instanceof d){d.prototype.initialize.apply(this,arguments)}else{return new d()}};d.prototype=Object.create(a.prototype,b);d.prototype.constructor=d;if(d.prototype.initialize==null){d.prototype.initialize=function(){a.apply(this,arguments)}}var e=this.getInheritanceTree(a);for(var i=0,l=e.length;i<l;i++){if(typeof e[i]._inherited==='function'){e[i]._inherited(d);break}}return d};z.Class.getInheritanceTree=function(a){var b=[];var C=a;var c=C.prototype;while(C!==Object){b.push(C);c=Object.getPrototypeOf(c);C=c.constructor}return b};z.ENV={VERSION:'0.8.1',BROWSER:(function(a){if(/Eagle/.test(a)){return'eagle'}else if(/Opera/.test(a)){return'opera'}else if(/MSIE|Trident/.test(a)){return'ie'}else if(/Chrome/.test(a)){return'chrome'}else if(/(?:Macintosh|Windows).*AppleWebKit/.test(a)){return'safari'}else if(/(?:iPhone|iPad|iPod).*AppleWebKit/.test(a)){return'mobilesafari'}else if(/Firefox/.test(a)){return'firefox'}else if(/Android/.test(a)){return'android'}else{return''}}(navigator.userAgent)),VENDOR_PREFIX:(function(){var a=navigator.userAgent;if(a.indexOf('Opera')!==-1){return'O'}else if(/MSIE|Trident/.test(a)){return'ms'}else if(a.indexOf('WebKit')!==-1){return'webkit'}else if(navigator.product==='Gecko'){return'Moz'}else{return''}}()),TOUCH_ENABLED:(function(){var a=document.createElement('div');a.setAttribute('ontouchstart','return');return typeof a.ontouchstart==='function'}()),RETINA_DISPLAY:(function(){if(navigator.userAgent.indexOf('iPhone')!==-1&&u.devicePixelRatio===2){var a=document.querySelector('meta[name="viewport"]');if(a==null){a=document.createElement('meta');document.head.appendChild(a)}a.setAttribute('content','width=640');return true}else{return false}}()),USE_FLASH_SOUND:(function(){var a=navigator.userAgent;var b=navigator.vendor||"";return(location.href.indexOf('http')===0&&a.indexOf('Mobile')===-1&&b.indexOf('Apple')!==-1)}()),USE_DEFAULT_EVENT_TAGS:['input','textarea','select','area'],CANVAS_DRAWING_METHODS:['putImageData','drawImage','drawFocusRing','fill','stroke','clearRect','fillRect','strokeRect','fillText','strokeText'],KEY_BIND_TABLE:{37:'left',38:'up',39:'right',40:'down'},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:true,USE_WEBAUDIO:(function(){return location.protocol!=='file:'}()),USE_ANIMATION:true};z.Event=z.Class.create({initialize:function(a){this.type=a;this.target=null;this.x=0;this.y=0;this.localX=0;this.localY=0},_initPosition:function(a,b){var c=z.Core.instance;this.x=this.localX=(a-c._pageX)/c.scale;this.y=this.localY=(b-c._pageY)/c.scale}});z.Event.LOAD='load';z.Event.ERROR='error';z.Event.CORE_RESIZE='coreresize';z.Event.PROGRESS='progress';z.Event.ENTER_FRAME='enterframe';z.Event.EXIT_FRAME='exitframe';z.Event.ENTER='enter';z.Event.EXIT='exit';z.Event.CHILD_ADDED='childadded';z.Event.ADDED='added';z.Event.ADDED_TO_SCENE='addedtoscene';z.Event.CHILD_REMOVED='childremoved';z.Event.REMOVED='removed';z.Event.REMOVED_FROM_SCENE='removedfromscene';z.Event.TOUCH_START='touchstart';z.Event.TOUCH_MOVE='touchmove';z.Event.TOUCH_END='touchend';z.Event.RENDER='render';z.Event.INPUT_START='inputstart';z.Event.INPUT_CHANGE='inputchange';z.Event.INPUT_END='inputend';z.Event.INPUT_STATE_CHANGED='inputstatechanged';z.Event.LEFT_BUTTON_DOWN='leftbuttondown';z.Event.LEFT_BUTTON_UP='leftbuttonup';z.Event.RIGHT_BUTTON_DOWN='rightbuttondown';z.Event.RIGHT_BUTTON_UP='rightbuttonup';z.Event.UP_BUTTON_DOWN='upbuttondown';z.Event.UP_BUTTON_UP='upbuttonup';z.Event.DOWN_BUTTON_DOWN='downbuttondown';z.Event.DOWN_BUTTON_UP='downbuttonup';z.Event.A_BUTTON_DOWN='abuttondown';z.Event.A_BUTTON_UP='abuttonup';z.Event.B_BUTTON_DOWN='bbuttondown';z.Event.B_BUTTON_UP='bbuttonup';z.Event.ADDED_TO_TIMELINE="addedtotimeline";z.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";z.Event.ACTION_START="actionstart";z.Event.ACTION_END="actionend";z.Event.ACTION_TICK="actiontick";z.Event.ACTION_ADDED="actionadded";z.Event.ACTION_REMOVED="actionremoved";z.EventTarget=z.Class.create({initialize:function(){this._listeners={}},addEventListener:function(a,b){var c=this._listeners[a];if(c==null){this._listeners[a]=[b]}else if(c.indexOf(b)===-1){c.unshift(b)}},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(a,b){var c=this._listeners[a];if(c!=null){var i=c.indexOf(b);if(i!==-1){c.splice(i,1)}}},clearEventListener:function(a){if(a!=null){delete this._listeners[a]}else{this._listeners={}}},dispatchEvent:function(e){e.target=this;e.localX=e.x-this._offsetX;e.localY=e.y-this._offsetY;if(this['on'+e.type]!=null){this['on'+e.type](e)}var a=this._listeners[e.type];if(a!=null){a=a.slice();for(var i=0,len=a.length;i<len;i++){a[i].call(this,e)}}}});(function(){var r;z.Core=z.Class.create(z.EventTarget,{initialize:function(f,g){if(u.document.body===null){throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");}z.EventTarget.call(this);var h=true;if(r){h=false;r.stop()}r=z.Core.instance=this;this._calledTime=0;this._mousedownID=0;this._surfaceID=0;this._soundID=0;this._scenes=[];f=f||320;g=g||320;var j=document.getElementById('enchant-stage');var k,sWidth,sHeight;if(!j){j=document.createElement('div');j.id='enchant-stage';j.style.position='absolute';if(document.body.firstChild){document.body.insertBefore(j,document.body.firstChild)}else{document.body.appendChild(j)}k=Math.min(u.innerWidth/f,u.innerHeight/g);this._pageX=j.getBoundingClientRect().left;this._pageY=j.getBoundingClientRect().top}else{var m=u.getComputedStyle(j);sWidth=parseInt(m.width,10);sHeight=parseInt(m.height,10);if(sWidth&&sHeight){k=Math.min(sWidth/f,sHeight/g)}else{k=1}while(j.firstChild){j.removeChild(j.firstChild)}j.style.position='relative';var n=j.getBoundingClientRect();this._pageX=Math.round(u.scrollX||u.pageXOffset+n.left);this._pageY=Math.round(u.scrollY||u.pageYOffset+n.top)}diffx=Math.floor((innerWidth-(f*k))/2);diffy=Math.floor((innerHeight-(g*k))/2);this._pageX+=diffx;this._pageY+=diffy;j.style.left=diffx+"px";j.style.top=diffy+"px";j.style.fontSize='12px';j.style.webkitTextSizeAdjust='none';j.style.webkitTapHighlightColor='rgba(0, 0, 0, 0)';this._element=j;this.addEventListener('coreresize',this._oncoreresize);this._width=f;this._height=g;this.scale=k;this.fps=30;this.frame=0;this.ready=false;this.running=false;this.assets={};var o=this._assets=[];(function detectAssets(a){if(a.assets){z.Core.instance.preload(a.assets)}for(var b in a){if(a.hasOwnProperty(b)){if(typeof a[b]==='object'&&a[b]!==null&&Object.getPrototypeOf(a[b])===Object.prototype){detectAssets(a[b])}}}}(z));this.currentScene=null;this.rootScene=new z.Scene();this.pushScene(this.rootScene);this.loadingScene=new z.LoadingScene();this._activated=false;this._offsetX=0;this._offsetY=0;this.input={};this.keyboardInputManager=new z.KeyboardInputManager(u.document,this.input);this.keyboardInputManager.addBroadcastTarget(this);this._keybind=this.keyboardInputManager._binds;if(!z.ENV.KEY_BIND_TABLE){z.ENV.KEY_BIND_TABLE={}}for(var p in z.ENV.KEY_BIND_TABLE){this.keybind(p,z.ENV.KEY_BIND_TABLE[p])}if(h){j=z.Core.instance._element;var q;document.addEventListener('keydown',function(e){r.dispatchEvent(new z.Event('keydown'));if(z.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(e.keyCode)!==-1){e.preventDefault();e.stopPropagation()}},true);if(z.ENV.TOUCH_ENABLED){j.addEventListener('touchstart',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();if(!r.running){e.stopPropagation()}}},true);j.addEventListener('touchmove',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();if(!r.running){e.stopPropagation()}}},true);j.addEventListener('touchend',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();if(!r.running){e.stopPropagation()}}},true)}j.addEventListener('mousedown',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();r._mousedownID++;if(!r.running){e.stopPropagation()}}},true);j.addEventListener('mousemove',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();if(!r.running){e.stopPropagation()}}},true);j.addEventListener('mouseup',function(e){var a=(e.target.tagName).toLowerCase();if(z.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(a)===-1){e.preventDefault();if(!r.running){e.stopPropagation()}}},true);r._touchEventTarget={};if(z.ENV.TOUCH_ENABLED){j.addEventListener('touchstart',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_START);var c=e.changedTouches;var d,target;for(var i=0,l=c.length;i<l;i++){d=c[i];b._initPosition(d.pageX,d.pageY);target=a.currentScene._determineEventTarget(b);a._touchEventTarget[d.identifier]=target;target.dispatchEvent(b)}},false);j.addEventListener('touchmove',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_MOVE);var c=e.changedTouches;var d,target;for(var i=0,l=c.length;i<l;i++){d=c[i];target=a._touchEventTarget[d.identifier];if(target){b._initPosition(d.pageX,d.pageY);target.dispatchEvent(b)}}},false);j.addEventListener('touchend',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_END);var c=e.changedTouches;var d,target;for(var i=0,l=c.length;i<l;i++){d=c[i];target=a._touchEventTarget[d.identifier];if(target){b._initPosition(d.pageX,d.pageY);target.dispatchEvent(b);delete a._touchEventTarget[d.identifier]}}},false)}j.addEventListener('mousedown',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_START);b._initPosition(e.pageX,e.pageY);var c=a.currentScene._determineEventTarget(b);a._touchEventTarget[a._mousedownID]=c;c.dispatchEvent(b)},false);j.addEventListener('mousemove',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_MOVE);b._initPosition(e.pageX,e.pageY);var c=a._touchEventTarget[a._mousedownID];if(c){c.dispatchEvent(b)}},false);j.addEventListener('mouseup',function(e){var a=z.Core.instance;var b=new z.Event(z.Event.TOUCH_END);b._initPosition(e.pageX,e.pageY);var c=a._touchEventTarget[a._mousedownID];if(c){c.dispatchEvent(b)}delete a._touchEventTarget[a._mousedownID]},false)}},width:{get:function(){return this._width},set:function(w){this._width=w;this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(h){this._height=h;this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(s){this._scale=s;this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var e=new z.Event('coreresize');e.width=this._width;e.height=this._height;e.scale=this._scale;this.dispatchEvent(e)},_oncoreresize:function(e){this._element.style.width=Math.floor(this._width*this._scale)+'px';this._element.style.height=Math.floor(this._height*this._scale)+'px';var a;for(var i=0,l=this._scenes.length;i<l;i++){a=this._scenes[i];a.dispatchEvent(e)}},preload:function(b){var a;if(!(b instanceof Array)){if(typeof b==='object'){a=[];for(var c in b){if(b.hasOwnProperty(c)){a.push([b[c],c])}}b=a}else{b=Array.prototype.slice.call(arguments)}}Array.prototype.push.apply(this._assets,b);return this},load:function(g,h,i,j){var k,offset;if(typeof arguments[1]==='string'){k=h;offset=1}else{k=g;offset=0}i=arguments[1+offset]||function(){};j=arguments[2+offset]||function(){};var l=z.Core.findExt(g);return z.Deferred.next(function(){var d=new z.Deferred();var b=function(e){d.call(e);i.call(this,e)};var c=function(e){d.fail(e);j.call(this,e)};if(z.Core._loadFuncs[l]){z.Core.instance.assets[k]=z.Core._loadFuncs[l](g,l,b,c)}else{var f=new XMLHttpRequest();f.open('GET',g,true);f.onreadystatechange=function(){if(f.readyState===4){if(f.status!==200&&f.status!==0){var e=new z.Event('error');e.message=f.status+': '+'Cannot load an asset: '+g;c.call(z.Core.instance,e)}var a=f.getResponseHeader('Content-Type')||'';if(a.match(/^image/)){r.assets[k]=z.Surface.load(g,b,c)}else if(a.match(/^audio/)){r.assets[k]=z.Sound.load(g,a,b,c)}else{r.assets[k]=f.responseText;b.call(z.Core.instance,new z.Event('load'))}}};f.send(null)}return d})},start:function(b){var c=function(){this.frame=0;this.removeEventListener('load',c)};this.addEventListener('load',c);this.currentTime=u.getTime();this.running=true;this.ready=true;if(!this._activated){this._activated=true;if(z.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&!r._touched&&(navigator.userAgent.indexOf('iPhone OS')!==-1||navigator.userAgent.indexOf('iPad')!==-1)){var d=new z.Deferred();var e=new z.Scene();e.backgroundColor='#000';var f=Math.round(r.width/10);var g=new z.Sprite(r.width,f);g.y=(r.height-f)/2;g.image=new z.Surface(r.width,f);g.image.context.fillStyle='#fff';g.image.context.font=(f-1)+'px bold Helvetica,Arial,sans-serif';var h=g.image.context.measureText('Touch to Start').width;g.image.context.fillText('Touch to Start',(r.width-h)/2,f-1);e.addChild(g);document.addEventListener('mousedown',function waitTouch(){document.removeEventListener('mousedown',waitTouch);r._touched=true;r.removeScene(e);r.start(d)},false);r.pushScene(e);return d}}this._requestNextFrame(0);var i=this._requestPreload().next(function(){z.Core.instance.loadingScene.dispatchEvent(new z.Event(z.Event.LOAD))});if(b){i.next(function(a){b.call(a)}).error(function(a){b.fail(a)})}return i},_requestPreload:function(){var o={};var c=0,len=0,loadFunc=function(){var e=new z.Event('progress');e.loaded=++c;e.total=len;r.loadingScene.dispatchEvent(e)};this._assets.reverse().forEach(function(a){var b,name;if(a instanceof Array){b=a[0];name=a[1]}else{b=name=a}if(!o[name]){o[name]=this.load(b,name,loadFunc);len++}},this);this.pushScene(this.loadingScene);return z.Deferred.parallel(o)},debug:function(){this._debug=true;return this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(b){if(!this.ready){return}if(this.fps>=60||b<=16){this._calledTime=u.getTime();u.requestAnimationFrame(this._callTick)}else{setTimeout(function(){var a=z.Core.instance;a._calledTime=u.getTime();u.requestAnimationFrame(a._callTick)},Math.max(0,b))}},_callTick:function(a){z.Core.instance._tick(a)},_tick:function(a){var e=new z.Event('enterframe');var b=u.getTime();var c=e.elapsed=b-this.currentTime;this._actualFps=c>0?(1000/c):0;var d=this.currentScene.childNodes.slice();var f=Array.prototype.push;while(d.length){var g=d.pop();g.age++;g.dispatchEvent(e);if(g.childNodes){f.apply(d,g.childNodes)}}this.currentScene.age++;this.currentScene.dispatchEvent(e);this.dispatchEvent(e);this.dispatchEvent(new z.Event('exitframe'));this.frame++;b=u.getTime();this.currentTime=b;this._requestNextFrame(1000/this.fps-(b-this._calledTime))},getTime:function(){return u.getTime()},stop:function(){this.ready=false;this.running=false},pause:function(){this.ready=false},resume:function(){if(this.ready){return}this.currentTime=u.getTime();this.ready=true;this.running=true;this._requestNextFrame(0)},pushScene:function(a){this._element.appendChild(a._element);if(this.currentScene){this.currentScene.dispatchEvent(new z.Event('exit'))}this.currentScene=a;this.currentScene.dispatchEvent(new z.Event('enter'));return this._scenes.push(a)},popScene:function(){if(this.currentScene===this.rootScene){return this.currentScene}this._element.removeChild(this.currentScene._element);this.currentScene.dispatchEvent(new z.Event('exit'));this.currentScene=this._scenes[this._scenes.length-2];this.currentScene.dispatchEvent(new z.Event('enter'));return this._scenes.pop()},replaceScene:function(a){this.popScene();return this.pushScene(a)},removeScene:function(a){if(this.currentScene===a){return this.popScene()}else{var i=this._scenes.indexOf(a);if(i!==-1){this._scenes.splice(i,1);this._element.removeChild(a._element);return a}else{return null}}},_buttonListener:function(e){this.currentScene.dispatchEvent(e)},keybind:function(a,b){this.keyboardInputManager.keybind(a,b);this.addEventListener(b+'buttondown',this._buttonListener);this.addEventListener(b+'buttonup',this._buttonListener);return this},keyunbind:function(a){var b=this._keybind[a];this.keyboardInputManager.keyunbind(a);this.removeEventListener(b+'buttondown',this._buttonListener);this.removeEventListener(b+'buttonup',this._buttonListener);return this},changeButtonState:function(a,b){this.keyboardInputManager.changeState(a,b)},getElapsedTime:function(){return this.frame/this.fps}});z.Core._loadFuncs={};z.Core._loadFuncs['jpg']=z.Core._loadFuncs['jpeg']=z.Core._loadFuncs['gif']=z.Core._loadFuncs['png']=z.Core._loadFuncs['bmp']=function(a,b,c,d){return z.Surface.load(a,c,d)};z.Core._loadFuncs['mp3']=z.Core._loadFuncs['aac']=z.Core._loadFuncs['m4a']=z.Core._loadFuncs['wav']=z.Core._loadFuncs['ogg']=function(a,b,c,d){return z.Sound.load(a,'audio/'+b,c,d)};z.Core.findExt=function(a){var b=a.match(/\.\w+$/);if(b&&b.length>0){return b[0].slice(1).toLowerCase()}if(a.indexOf('data:')===0){return a.split(/[\/;]/)[1].toLowerCase()}return null};z.Core.instance=null}());z.Game=z.Core;z.InputManager=z.Class.create(z.EventTarget,{initialize:function(c,d){z.EventTarget.call(this);this.broadcastTarget=[];this.valueStore=c;this.source=d||this;this._binds={};this._stateHandler=function(e){var a=e.source.identifier;var b=this._binds[a];this.changeState(b,e.data)}.bind(this)},bind:function(a,b){a.addEventListener(z.Event.INPUT_STATE_CHANGED,this._stateHandler);this._binds[a.identifier]=b},unbind:function(a){a.removeEventListener(z.Event.INPUT_STATE_CHANGED,this._stateHandler);delete this._binds[a.identifier]},addBroadcastTarget:function(a){var i=this.broadcastTarget.indexOf(a);if(i===-1){this.broadcastTarget.push(a)}},removeBroadcastTarget:function(a){var i=this.broadcastTarget.indexOf(a);if(i!==-1){this.broadcastTarget.splice(i,1)}},broadcastEvent:function(e){var a=this.broadcastTarget;for(var i=0,l=a.length;i<l;i++){a[i].dispatchEvent(e)}},changeState:function(a,b){}});z.InputSource=z.Class.create(z.EventTarget,{initialize:function(a){z.EventTarget.call(this);this.identifier=a},notifyStateChange:function(a){var e=new z.Event(z.Event.INPUT_STATE_CHANGED);e.data=a;e.source=this;this.dispatchEvent(e)}});z.BinaryInputManager=z.Class.create(z.InputManager,{initialize:function(a,b,c,d){z.InputManager.call(this,a,d);this.activeInputsNum=0;this.activeEventNameSuffix=b;this.inactiveEventNameSuffix=c},bind:function(a,b){z.InputManager.prototype.bind.call(this,a,b);this.valueStore[b]=false},unbind:function(a){z.InputManager.prototype.unbind.call(this,a);var b=this._binds[a.identifier];delete this.valueStore[b]},changeState:function(a,b){if(b){this._down(a)}else{this._up(a)}},_down:function(a){var b;if(!this.valueStore[a]){this.valueStore[a]=true;b=new z.Event((this.activeInputsNum++)?'inputchange':'inputstart');b.source=this.source;this.broadcastEvent(b)}var c=new z.Event(a+this.activeEventNameSuffix);c.source=this.source;this.broadcastEvent(c)},_up:function(a){var b;if(this.valueStore[a]){this.valueStore[a]=false;b=new z.Event((--this.activeInputsNum)?'inputchange':'inputend');b.source=this.source;this.broadcastEvent(b)}var c=new z.Event(a+this.inactiveEventNameSuffix);c.source=this.source;this.broadcastEvent(c)}});z.BinaryInputSource=z.Class.create(z.InputSource,{initialize:function(a){z.InputSource.call(this,a)}});z.KeyboardInputManager=z.Class.create(z.BinaryInputManager,{initialize:function(a,b){z.BinaryInputManager.call(this,b,'buttondown','buttonup');this._attachDOMEvent(a,'keydown',true);this._attachDOMEvent(a,'keyup',false)},keybind:function(a,b){this.bind(z.KeyboardInputSource.getByKeyCode(''+a),b)},keyunbind:function(a){this.unbind(z.KeyboardInputSource.getByKeyCode(''+a))},_attachDOMEvent:function(d,f,g){d.addEventListener(f,function(e){var a=z.Core.instance;if(!a||!a.running){return}var b=e.keyCode;var c=z.KeyboardInputSource._instances[b];if(c){c.notifyStateChange(g)}},true)}});z.KeyboardInputSource=z.Class.create(z.BinaryInputSource,{initialize:function(a){z.BinaryInputSource.call(this,a)}});z.KeyboardInputSource._instances={};z.KeyboardInputSource.getByKeyCode=function(a){if(!this._instances[a]){this._instances[a]=new z.KeyboardInputSource(a)}return this._instances[a]};z.Node=z.Class.create(z.EventTarget,{initialize:function(){z.EventTarget.call(this);this._dirty=false;this._matrix=[1,0,0,1,0,0];this._x=0;this._y=0;this._offsetX=0;this._offsetY=0;this.age=0;this.parentNode=null;this.scene=null;this.addEventListener('touchstart',function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener('touchmove',function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener('touchend',function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});if(z.ENV.USE_ANIMATION){this.tl=new z.Timeline(this)}},moveTo:function(x,y){this._x=x;this._y=y;this._dirty=true},moveBy:function(x,y){this._x+=x;this._y+=y;this._dirty=true},x:{get:function(){return this._x},set:function(x){this._x=x;this._dirty=true}},y:{get:function(){return this._y},set:function(y){this._y=y;this._dirty=true}},_updateCoordinate:function(){var a=this;var b=[a];var c=a.parentNode;var d=this.scene;while(c&&a._dirty){b.unshift(c);a=a.parentNode;c=a.parentNode}var e=z.Matrix.instance;var f=e.stack;var g=[];var h,ox,oy;f.push(b[0]._matrix);for(var i=1,l=b.length;i<l;i++){a=b[i];h=[];e.makeTransformMatrix(a,g);e.multiply(f[f.length-1],g,h);a._matrix=h;f.push(h);ox=(typeof a._originX==='number')?a._originX:a._width/2||0;oy=(typeof a._originY==='number')?a._originY:a._height/2||0;var j=[ox,oy];e.multiplyVec(h,j,j);a._offsetX=j[0]-ox;a._offsetY=j[1]-oy;a._dirty=false}e.reset()},remove:function(){if(this._listener){this.clearEventListener()}if(this.parentNode){this.parentNode.removeChild(this)}}});var A=function(a,b){var d=[];var c;for(var i=0,l=a.collection.length;i<l;i++){c=a.collection[i];if(b._intersectOne(c)){d.push(c)}}return d};var B=function(a,b){var c=[];var d,c2;for(var i=0,l=a.collection.length;i<l;i++){d=a.collection[i];for(var j=0,ll=b.collection.length;j<ll;j++){c2=b.collection[j];if(d._intersectOne(c2)){c.push([d,c2])}}}return c};var D=function(a,b){var d=[];var c;for(var i=0,l=a.collection.length;i<l;i++){c=a.collection[i];if(b._intersectStrictOne(c)){d.push(c)}}return d};var E=function(a,b){var c=[];var d,c2;for(var i=0,l=a.collection.length;i<l;i++){d=a.collection[i];for(var j=0,ll=b.collection.length;j<ll;j++){c2=b.collection[j];if(d._intersectStrictOne(c2)){c.push([d,c2])}}}return c};var G=function(a){if(a instanceof z.Entity){return A(this,a)}else if(typeof a==='function'&&a.collection){return B(this,a)}return false};var H=function(a){if(a instanceof z.Entity){return D(this,a)}else if(typeof a==='function'&&a.collection){return E(this,a)}return false};z.Entity=z.Class.create(z.Node,{initialize:function(){var a=z.Core.instance;z.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._touchEnabled=true;this._clipping=false;this._originX=null;this._originY=null;this._width=0;this._height=0;this._backgroundColor=null;this._debugColor='#0000ff';this._opacity=1;this._visible=true;this._buttonMode=null;this._style={};this.__styleStatus={};this._isContainedInCollection=false;this.compositeOperation=null;this.buttonMode=null;this.buttonPressed=false;this.addEventListener('touchstart',function(){if(!this.buttonMode){return}this.buttonPressed=true;this.dispatchEvent(new z.Event(this.buttonMode+'buttondown'));a.changeButtonState(this.buttonMode,true)});this.addEventListener('touchend',function(){if(!this.buttonMode){return}this.buttonPressed=false;this.dispatchEvent(new z.Event(this.buttonMode+'buttonup'));a.changeButtonState(this.buttonMode,false)});this.enableCollection()},width:{get:function(){return this._width},set:function(a){this._width=a;this._dirty=true}},height:{get:function(){return this._height},set:function(a){this._height=a;this._dirty=true}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=a}},debugColor:{get:function(){return this._debugColor},set:function(a){this._debugColor=a}},opacity:{get:function(){return this._opacity},set:function(a){this._opacity=parseFloat(a)}},visible:{get:function(){return this._visible},set:function(a){this._visible=a}},touchEnabled:{get:function(){return this._touchEnabled},set:function(a){this._touchEnabled=a;if(a){this._style.pointerEvents='all'}else{this._style.pointerEvents='none'}}},intersect:function(a){if(a instanceof z.Entity){return this._intersectOne(a)}else if(typeof a==='function'&&a.collection){return A(a,this)}return false},_intersectOne:function(a){if(this._dirty){this._updateCoordinate()}if(a._dirty){a._updateCoordinate()}return this._offsetX<a._offsetX+a.width&&a._offsetX<this._offsetX+this.width&&this._offsetY<a._offsetY+a.height&&a._offsetY<this._offsetY+this.height},intersectStrict:function(a){if(a instanceof z.Entity){return this._intersectStrictOne(a)}else if(typeof a==='function'&&a.collection){return D(a,this)}return false},_intersectStrictOne:function(a){if(this._dirty){this._updateCoordinate()}if(a._dirty){a._updateCoordinate()}var b=this.getOrientedBoundingRect(),rect2=a.getOrientedBoundingRect(),lt1=b.leftTop,rt1=b.rightTop,lb1=b.leftBottom,rb1=b.rightBottom,lt2=rect2.leftTop,rt2=rect2.rightTop,lb2=rect2.leftBottom,rb2=rect2.rightBottom,ltx1=lt1[0],lty1=lt1[1],rtx1=rt1[0],rty1=rt1[1],lbx1=lb1[0],lby1=lb1[1],rbx1=rb1[0],rby1=rb1[1],ltx2=lt2[0],lty2=lt2[1],rtx2=rt2[0],rty2=rt2[1],lbx2=lb2[0],lby2=lb2[1],rbx2=rb2[0],rby2=rb2[1],t1=[rtx1-ltx1,rty1-lty1],r1=[rbx1-rtx1,rby1-rty1],b1=[lbx1-rbx1,lby1-rby1],l1=[ltx1-lbx1,lty1-lby1],t2=[rtx2-ltx2,rty2-lty2],r2=[rbx2-rtx2,rby2-rty2],b2=[lbx2-rbx2,lby2-rby2],l2=[ltx2-lbx2,lty2-lby2],cx1=(ltx1+rtx1+lbx1+rbx1)>>2,cy1=(lty1+rty1+lby1+rby1)>>2,cx2=(ltx2+rtx2+lbx2+rbx2)>>2,cy2=(lty2+rty2+lby2+rby2)>>2,i,j,poss1,poss2,dirs1,dirs2,pos1,pos2,dir1,dir2,px1,py1,px2,py2,dx1,dy1,dx2,dy2,vx,vy,c,c1,c2;if(t1[0]*(cy2-lty1)-t1[1]*(cx2-ltx1)>0&&r1[0]*(cy2-rty1)-r1[1]*(cx2-rtx1)>0&&b1[0]*(cy2-rby1)-b1[1]*(cx2-rbx1)>0&&l1[0]*(cy2-lby1)-l1[1]*(cx2-lbx1)>0){return true}else if(t2[0]*(cy1-lty2)-t2[1]*(cx1-ltx2)>0&&r2[0]*(cy1-rty2)-r2[1]*(cx1-rtx2)>0&&b2[0]*(cy1-rby2)-b2[1]*(cx1-rbx2)>0&&l2[0]*(cy1-lby2)-l2[1]*(cx1-lbx2)>0){return true}else{poss1=[lt1,rt1,rb1,lb1];poss2=[lt2,rt2,rb2,lb2];dirs1=[t1,r1,b1,l1];dirs2=[t2,r2,b2,l2];for(i=0;i<4;i++){pos1=poss1[i];px1=pos1[0];py1=pos1[1];dir1=dirs1[i];dx1=dir1[0];dy1=dir1[1];for(j=0;j<4;j++){pos2=poss2[j];px2=pos2[0];py2=pos2[1];dir2=dirs2[j];dx2=dir2[0];dy2=dir2[1];c=dx1*dy2-dy1*dx2;if(c!==0){vx=px2-px1;vy=py2-py1;c1=(vx*dy1-vy*dx1)/c;c2=(vx*dy2-vy*dx2)/c;if(0<c1&&c1<1&&0<c2&&c2<1){return true}}}}return false}},within:function(a,b){if(this._dirty){this._updateCoordinate()}if(a._dirty){a._updateCoordinate()}if(b==null){b=(this.width+this.height+a.width+a.height)/4}var _;return(_=this._offsetX-a._offsetX+(this.width-a.width)/2)*_+(_=this._offsetY-a._offsetY+(this.height-a.height)/2)*_<b*b},scale:function(x,y){this._scaleX*=x;this._scaleY*=(y!=null)?y:x;this._dirty=true},rotate:function(a){this._rotation+=a;this._dirty=true},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;this._dirty=true}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;this._dirty=true}},originX:{get:function(){return this._originX},set:function(a){this._originX=a;this._dirty=true}},originY:{get:function(){return this._originY},set:function(a){this._originY=a;this._dirty=true}},enableCollection:function(){this.addEventListener('addedtoscene',this._addSelfToCollection);this.addEventListener('removedfromscene',this._removeSelfFromCollection);if(this.scene){this._addSelfToCollection()}},disableCollection:function(){this.removeEventListener('addedtoscene',this._addSelfToCollection);this.removeEventListener('removedfromscene',this._removeSelfFromCollection);if(this.scene){this._removeSelfFromCollection()}},_addSelfToCollection:function(){if(this._isContainedInCollection){return}var a=this.getConstructor();a._collectionTarget.forEach(function(C){C.collection.push(this)},this);this._isContainedInCollection=true},_removeSelfFromCollection:function(){if(!this._isContainedInCollection){return}var a=this.getConstructor();a._collectionTarget.forEach(function(C){var i=C.collection.indexOf(this);if(i!==-1){C.collection.splice(i,1)}},this);this._isContainedInCollection=false},getBoundingRect:function(){var w=this.width||0;var h=this.height||0;var c=this._matrix;var d=c[0]*w,m12w=c[1]*w,m21h=c[2]*h,m22h=c[3]*h,mdx=c[4],mdy=c[5];var e=[mdx,d+mdx,m21h+mdx,d+m21h+mdx].sort(function(a,b){return a-b});var f=[mdy,m12w+mdy,m22h+mdy,m12w+m22h+mdy].sort(function(a,b){return a-b});return{left:e[0],top:f[0],width:e[3]-e[0],height:f[3]-f[0]}},getOrientedBoundingRect:function(){var w=this.width||0;var h=this.height||0;var a=this._matrix;var b=a[0]*w,m12w=a[1]*w,m21h=a[2]*h,m22h=a[3]*h,mdx=a[4],mdy=a[5];return{leftTop:[mdx,mdy],rightTop:[b+mdx,m12w+mdy],leftBottom:[m21h+mdx,m22h+mdy],rightBottom:[b+m21h+mdx,m12w+m22h+mdy]}},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var I=function(a){if(a._collective){return}var b=z.Class.getInheritanceTree(a);var i=b.indexOf(z.Entity);if(i!==-1){a._collectionTarget=b.splice(0,i+1)}else{a._collectionTarget=[]}a.intersect=G;a.intersectStrict=H;a.collection=[];a._collective=true};I(z.Entity);z.Entity._inherited=function(a){I(a)};z.Sprite=z.Class.create(z.Entity,{initialize:function(a,b){z.Entity.call(this);this.width=a;this.height=b;this._image=null;this._debugColor='#ff0000';this._frameLeft=0;this._frameTop=0;this._frame=0;this._frameSequence=[];this.addEventListener(z.Event.ENTER_FRAME,this._rotateFrameSequence)},image:{get:function(){return this._image},set:function(a){if(a===v){throw new Error('Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.');}if(a===this._image){return}this._image=a;this._computeFramePosition()}},frame:{get:function(){return this._frame},set:function(a){if(this._frame===a){return}if(a instanceof Array){this._frameSequence=a.slice();this._rotateFrameSequence()}else{this._frameSequence=[];this._frame=a;this._computeFramePosition()}}},_computeFramePosition:function(){var a=this._image;var b;if(a!=null){b=a.width/this._width|0;this._frameLeft=(this._frame%b|0)*this._width;this._frameTop=(this._frame/b|0)*this._height%a.height}},_rotateFrameSequence:function(){if(this._frameSequence.length!==0){var a=this._frameSequence.shift();if(a===null){this._frameSequence=[]}else{this._frame=a;this._computeFramePosition();this._frameSequence.push(a)}}},width:{get:function(){return this._width},set:function(a){this._width=a;this._computeFramePosition();this._dirty=true}},height:{get:function(){return this._height},set:function(a){this._height=a;this._computeFramePosition();this._dirty=true}},cvsRender:function(a){var b=this._image,w=this._width,h=this._height,iw,ih,elem,sx,sy,sw,sh;if(b&&w!==0&&h!==0){iw=b.width,ih=b.height;if(iw<w||ih<h){a.fillStyle=z.Surface._getPattern(b);a.fillRect(0,0,w,h)}else{elem=b._element;sx=this._frameLeft;sy=Math.min(this._frameTop,ih-h);sw=Math.max(0.01,Math.min(iw-sx,w));sh=Math.max(0.01,Math.min(ih-sy,h));a.drawImage(elem,sx,sy,sw,sh,0,0,w,h)}}},domRender:(function(){if(z.ENV.VENDOR_PREFIX==='ms'){return function(a){if(this._image){if(this._image._css){this._style['background-image']=this._image._css;this._style['background-position']=-this._frameLeft+'px '+ -this._frameTop+'px'}else if(this._image._element){}}}}else{return function(a){if(this._image){if(this._image._css){this._style['background-image']=this._image._css;this._style['background-position']=-this._frameLeft+'px '+ -this._frameTop+'px'}else if(this._image._element){}}}}}())});z.Label=z.Class.create(z.Entity,{initialize:function(a){z.Entity.call(this);this.text=a||'';this.width=300;this.font='14px serif';this.textAlign='left';this._debugColor='#ff0000'},width:{get:function(){return this._width},set:function(a){this._width=a;this._dirty=true;this.updateBoundArea()}},text:{get:function(){return this._text},set:function(a){a=''+a;if(this._text===a){return}this._text=a;a=a.replace(/<(br|BR) ?\/?>/g,'<br/>');this._splitText=a.split('<br/>');this.updateBoundArea();for(var i=0,l=this._splitText.length;i<l;i++){a=this._splitText[i];var b=this.getMetrics(a);this._splitText[i]={};this._splitText[i].text=a;this._splitText[i].height=b.height}}},textAlign:{get:function(){return this._style['text-align']},set:function(a){this._style['text-align']=a;this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(a){this._style.font=a;this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(a){this._style.color=a}},cvsRender:function(a){var x,y=0;var b=this.width;var d,amount,line,text,c,buf,increase,length;var e;if(this._splitText){a.textBaseline='top';a.font=this.font;a.fillStyle=this.color||'#000000';d=a.measureText(' ').width;amount=b/d;for(var i=0,l=this._splitText.length;i<l;i++){line=this._splitText[i];text=line.text;c=0;while(text.length>c+amount||a.measureText(text.slice(c,c+amount)).width>b){buf='';increase=amount;length=0;while(increase>0){if(a.measureText(buf).width<b){length+=increase;buf=text.slice(c,c+length)}else{length-=increase;buf=text.slice(c,c+length)}increase=increase/2|0}a.fillText(buf,0,y);y+=line.height-1;c+=length}buf=text.slice(c,c+text.length);if(this.textAlign==='right'){x=b-a.measureText(buf).width}else if(this.textAlign==='center'){x=(b-a.measureText(buf).width)/2}else{x=0}a.fillText(buf,x,y);y+=line.height-1}}},domRender:function(a){if(a.innerHTML!==this._text){a.innerHTML=this._text}},detectRender:function(a){a.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var a=this.getMetrics();this._boundWidth=a.width;this._boundHeight=a.height;if(this.textAlign==='right'){this._boundOffset=this.width-this._boundWidth}else if(this.textAlign==='center'){this._boundOffset=(this.width-this._boundWidth)/2}else{this._boundOffset=0}},getMetrics:function(a){var b={};var c,width,height;if(document.body){c=document.createElement('div');for(var d in this._style){if(d!=='width'&&d!=='height'){c.style[d]=this._style[d]}}a=a||this._text;c.innerHTML=a.replace(/ /g,'&nbsp;');c.style.whiteSpace='noWrap';c.style.lineHeight=1;document.body.appendChild(c);b.height=parseInt(getComputedStyle(c).height,10)+1;c.style.position='absolute';b.width=parseInt(getComputedStyle(c).width,10)+1;document.body.removeChild(c)}else{b.width=this.width;b.height=this.height}return b}});z.Map=z.Class.create(z.Entity,{initialize:function(i,j){var k=z.Core.instance;z.Entity.call(this);var l=new z.Surface(k.width,k.height);this._surface=l;var m=l._element;m.style.position='absolute';if(z.ENV.RETINA_DISPLAY&&k.scale===2){m.width=k.width*2;m.height=k.height*2;this._style.webkitTransformOrigin='0 0';this._style.webkitTransform='scale(0.5)'}else{m.width=k.width;m.height=k.height}this._context=m.getContext('2d');this._tileWidth=i||0;this._tileHeight=j||0;this._image=null;this._data=[[[]]];this._dirty=false;this._tight=false;this.touchEnabled=false;this.collisionData=null;this._listeners['render']=null;this.addEventListener('render',function(){if(this._dirty||this._previousOffsetX==null){this.redraw(0,0,k.width,k.height)}else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY){if(this._tight){var x=-this._offsetX;var y=-this._offsetY;var a=-this._previousOffsetX;var b=-this._previousOffsetY;var c=x-a+k.width;var d=a-x+k.width;var e=y-b+k.height;var f=b-y+k.height;if(c>this._tileWidth&&d>this._tileWidth&&e>this._tileHeight&&f>this._tileHeight){var g,sy,dx,dy,sw,sh;if(c<d){g=0;dx=a-x;sw=c}else{g=x-a;dx=0;sw=d}if(e<f){sy=0;dy=b-y;sh=e}else{sy=y-b;dy=0;sh=f}if(k._buffer==null){k._buffer=document.createElement('canvas');k._buffer.width=this._context.canvas.width;k._buffer.height=this._context.canvas.height}var h=k._buffer.getContext('2d');if(this._doubledImage){h.clearRect(0,0,sw*2,sh*2);h.drawImage(this._context.canvas,g*2,sy*2,sw*2,sh*2,0,0,sw*2,sh*2);h=this._context;h.clearRect(dx*2,dy*2,sw*2,sh*2);h.drawImage(k._buffer,0,0,sw*2,sh*2,dx*2,dy*2,sw*2,sh*2)}else{h.clearRect(0,0,sw,sh);h.drawImage(this._context.canvas,g,sy,sw,sh,0,0,sw,sh);h=this._context;h.clearRect(dx,dy,sw,sh);h.drawImage(k._buffer,0,0,sw,sh,dx,dy,sw,sh)}if(dx===0){this.redraw(sw,0,k.width-sw,k.height)}else{this.redraw(0,0,k.width-sw,k.height)}if(dy===0){this.redraw(0,sh,k.width,k.height-sh)}else{this.redraw(0,0,k.width,k.height-sh)}}else{this.redraw(0,0,k.width,k.height)}}else{this.redraw(0,0,k.width,k.height)}}this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY})},loadData:function(a){this._data=Array.prototype.slice.apply(arguments);this._dirty=true;this._tight=false;for(var i=0,len=this._data.length;i<len;i++){var c=0;a=this._data[i];for(var y=0,l=a.length;y<l;y++){for(var x=0,ll=a[y].length;x<ll;x++){if(a[y][x]>=0){c++}}}if(c/(a.length*a[0].length)>0.2){this._tight=true;break}}},checkTile:function(x,y){if(x<0||this.width<=x||y<0||this.height<=y){return false}var a=this._image.width;var b=this._image.height;var c=this._tileWidth||a;var d=this._tileHeight||b;x=x/c|0;y=y/d|0;var e=this._data[0];return e[y][x]},hitTest:function(x,y){if(x<0||this.width<=x||y<0||this.height<=y){return false}var a=this._image.width;var b=this._image.height;var c=this._tileWidth||a;var d=this._tileHeight||b;x=x/c|0;y=y/d|0;if(this.collisionData!=null){return this.collisionData[y]&&!!this.collisionData[y][x]}else{for(var i=0,len=this._data.length;i<len;i++){var e=this._data[i];var n;if(e[y]!=null&&(n=e[y][x])!=null&&0<=n&&n<(a/c|0)*(b/d|0)){return true}}return false}},image:{get:function(){return this._image},set:function(a){var b=z.Core.instance;this._image=a;if(z.ENV.RETINA_DISPLAY&&b.scale===2){var c=new z.Surface(a.width*2,a.height*2);var d=this._tileWidth||a.width;var e=this._tileHeight||a.height;var f=a.width/d|0;var g=a.height/e|0;for(var y=0;y<g;y++){for(var x=0;x<f;x++){c.draw(a,x*d,y*e,d,e,x*d*2,y*e*2,d*2,e*2)}}this._doubledImage=c}this._dirty=true}},tileWidth:{get:function(){return this._tileWidth},set:function(a){this._tileWidth=a;this._dirty=true}},tileHeight:{get:function(){return this._tileHeight},set:function(a){this._tileHeight=a;this._dirty=true}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(x,y,a,c){if(this._image==null){return}var d,tileWidth,tileHeight,dx,dy;if(this._doubledImage){d=this._doubledImage;tileWidth=this._tileWidth*2;tileHeight=this._tileHeight*2;dx=-this._offsetX*2;dy=-this._offsetY*2;x*=2;y*=2;a*=2;c*=2}else{d=this._image;tileWidth=this._tileWidth;tileHeight=this._tileHeight;dx=-this._offsetX;dy=-this._offsetY}var e=d.width/tileWidth|0;var f=d.height/tileHeight|0;var g=Math.max((x+dx)/tileWidth|0,0);var h=Math.max((y+dy)/tileHeight|0,0);var j=Math.ceil((x+dx+a)/tileWidth);var k=Math.ceil((y+dy+c)/tileHeight);var l=d._element;var m=this._context;var o=m.canvas;m.clearRect(x,y,a,c);for(var i=0,len=this._data.length;i<len;i++){var p=this._data[i];var r=Math.min(j,p[0].length);var b=Math.min(k,p.length);for(y=h;y<b;y++){for(x=g;x<r;x++){var n=p[y][x];if(0<=n&&n<e*f){var q=(n%e)*tileWidth;var s=(n/e|0)*tileHeight;m.drawImage(l,q,s,tileWidth,tileHeight,x*tileWidth-dx,y*tileHeight-dy,tileWidth,tileHeight)}}}}},cvsRender:function(a){var b=z.Core.instance;if(this.width!==0&&this.height!==0){a.save();a.setTransform(1,0,0,1,0,0);var c=this._context.canvas;a.drawImage(c,0,0,b.width,b.height);a.restore()}},domRender:function(a){if(this._image){this._style['background-image']=this._surface._css;this._style[z.ENV.VENDOR_PREFIX+'Transform']='matrix(1, 0, 0, 1, 0, 0)'}}});z.Group=z.Class.create(z.Node,{initialize:function(){this.childNodes=[];z.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._originX=null;this._originY=null;this.__dirty=false;[z.Event.ADDED_TO_SCENE,z.Event.REMOVED_FROM_SCENE].forEach(function(b){this.addEventListener(b,function(e){this.childNodes.forEach(function(a){a.scene=this.scene;a.dispatchEvent(e)},this)})},this)},addChild:function(a){if(a.parentNode){a.parentNode.removeChild(a)}this.childNodes.push(a);a.parentNode=this;var b=new z.Event('childadded');b.node=a;b.next=null;this.dispatchEvent(b);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var c=new z.Event('addedtoscene');a.dispatchEvent(c)}},insertBefore:function(a,b){if(a.parentNode){a.parentNode.removeChild(a)}var i=this.childNodes.indexOf(b);if(i!==-1){this.childNodes.splice(i,0,a);a.parentNode=this;var c=new z.Event('childadded');c.node=a;c.next=b;this.dispatchEvent(c);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var d=new z.Event('addedtoscene');a.dispatchEvent(d)}}else{this.addChild(a)}},removeChild:function(a){var i;if((i=this.childNodes.indexOf(a))!==-1){this.childNodes.splice(i,1);a.parentNode=null;var b=new z.Event('childremoved');b.node=a;this.dispatchEvent(b);a.dispatchEvent(new z.Event('removed'));if(this.scene){a.scene=null;var c=new z.Event('removedfromscene');a.dispatchEvent(c)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;this._dirty=true}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;this._dirty=true}},originX:{get:function(){return this._originX},set:function(a){this._originX=a;this._dirty=true}},originY:{get:function(){return this._originY},set:function(a){this._originY=a;this._dirty=true}},_dirty:{get:function(){return this.__dirty},set:function(a){a=!!a;this.__dirty=a;if(a){for(var i=0,l=this.childNodes.length;i<l;i++){this.childNodes[i]._dirty=true}}}}});z.Matrix=z.Class.create({initialize:function(){this.reset()},reset:function(){this.stack=[];this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(e,f){var x=e._x;var y=e._y;var g=e.width||0;var i=e.height||0;var j=e._rotation||0;var k=(typeof e._scaleX==='number')?e._scaleX:1;var l=(typeof e._scaleY==='number')?e._scaleY:1;var m=j*Math.PI/180;var n=Math.cos(m);var o=Math.sin(m);var w=(typeof e._originX==='number')?e._originX:g/2;var h=(typeof e._originY==='number')?e._originY:i/2;var a=k*n;var b=k*o;var c=l*o;var d=l*n;f[0]=a;f[1]=b;f[2]=-c;f[3]=d;f[4]=(-a*w+c*h+x+w);f[5]=(-b*w-d*h+y+h)},multiply:function(a,b,c){var d=a[0],a21=a[2],adx=a[4],a12=a[1],a22=a[3],ady=a[5];var e=b[0],b21=b[2],bdx=b[4],b12=b[1],b22=b[3],bdy=b[5];c[0]=d*e+a21*b12;c[1]=a12*e+a22*b12;c[2]=d*b21+a21*b22;c[3]=a12*b21+a22*b22;c[4]=d*bdx+a21*bdy+adx;c[5]=a12*bdx+a22*bdy+ady},multiplyVec:function(a,b,c){var x=b[0],y=b[1];var d=a[0],m21=a[2],mdx=a[4],m12=a[1],m22=a[3],mdy=a[5];c[0]=d*x+m21*y+mdx;c[1]=m12*x+m22*y+mdy}});z.Matrix.instance=new z.Matrix();z.DetectColorManager=z.Class.create({initialize:function(a,b){this.reference=[];this.colorResolution=a||16;this.max=b||1;this.capacity=Math.pow(this.colorResolution,3);for(var i=1,l=this.capacity;i<l;i++){this.reference[i]=null}},attachDetectColor:function(a){var i=this.reference.indexOf(null);if(i===-1){i=1}this.reference[i]=a;return this._getColor(i)},detachDetectColor:function(a){var i=this.reference.indexOf(a);if(i!==-1){this.reference[i]=null}},_getColor:function(n){var C=this.colorResolution;var d=C/this.max;return[parseInt((n/C/C)%C,10)/d,parseInt((n/C)%C,10)/d,parseInt(n%C,10)/d,1.0]},_decodeDetectColor:function(a){var C=this.colorResolution;return~~(a[0]*C*C*C/256)+~~(a[1]*C*C/256)+~~(a[2]*C/256)},getSpriteByColor:function(a){return this.reference[this._decodeDetectColor(a)]}});z.DomManager=z.Class.create({initialize:function(a,b){var c=z.Core.instance;this.layer=null;this.targetNode=a;if(typeof b==='string'){this.element=document.createElement(b)}else if(b instanceof HTMLElement){this.element=b}this.style=this.element.style;this.style.position='absolute';this.style[z.ENV.VENDOR_PREFIX+'TransformOrigin']='0px 0px';if(c._debug){this.style.border='1px solid blue';this.style.margin='-1px'}var d=this;this._setDomTarget=function(){d.layer._touchEventTarget=d.targetNode};this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(a){var i=this.targetNode.parentNode.childNodes.indexOf(a.targetNode);if(i!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[i+1]._domManager}else{return null}},addManager:function(b,c){var d;if(c){d=c.getDomElementAsNext()}var e=b.getDomElement();if(e instanceof Array){e.forEach(function(a){if(d){this.element.insertBefore(a,d)}else{this.element.appendChild(a)}},this)}else{if(d){this.element.insertBefore(e,d)}else{this.element.appendChild(e)}}this.setLayer(this.layer)},removeManager:function(b){if(b instanceof z.DomlessManager){b._domRef.forEach(function(a){this.element.removeChild(a)},this)}else{this.element.removeChild(b.element)}this.setLayer(this.layer)},setLayer:function(a){this.layer=a;var b=this.targetNode;var c;if(b.childNodes){for(var i=0,l=b.childNodes.length;i<l;i++){c=b.childNodes[i]._domManager;if(c){c.setLayer(a)}}}},render:function(a){var b=this.targetNode;var c=z.Matrix.instance;var d=c.stack;var e=[];c.makeTransformMatrix(b,e);c.multiply(d[d.length-1],e,e);c.multiply(a,e,a);b._matrix=a;var f=(typeof b._originX==='number')?b._originX:b.width/2||0;var g=(typeof b._originY==='number')?b._originY:b.height/2||0;var h=[f,g];c.multiplyVec(e,h,h);b._offsetX=h[0]-f;b._offsetY=h[1]-g;if(b.parentNode&&!(b.parentNode instanceof z.Group)){b._offsetX+=b.parentNode._offsetX;b._offsetY+=b.parentNode._offsetY}if(b._dirty){this.style[z.ENV.VENDOR_PREFIX+'Transform']='matrix('+e[0].toFixed(10)+','+e[1].toFixed(10)+','+e[2].toFixed(10)+','+e[3].toFixed(10)+','+e[4].toFixed(10)+','+e[5].toFixed(10)+')'}this.domRender()},domRender:function(){var a=this.targetNode;if(!a._style){a._style={}}if(!a.__styleStatus){a.__styleStatus={}}if(a.width!==null){a._style.width=a.width+'px'}if(a.height!==null){a._style.height=a.height+'px'}a._style.opacity=a._opacity;a._style['background-color']=a._backgroundColor;if(typeof a._visible!=='undefined'){a._style.display=a._visible?'block':'none'}if(typeof a.domRender==='function'){a.domRender(this.element)}var b;for(var c in a._style){b=a._style[c];if(a.__styleStatus[c]!==b&&b!=null){this.style.setProperty(c,''+b);a.__styleStatus[c]=b}}},_attachEvent:function(){if(z.ENV.TOUCH_ENABLED){this.element.addEventListener('touchstart',this._setDomTarget,true)}this.element.addEventListener('mousedown',this._setDomTarget,true)},_detachEvent:function(){if(z.ENV.TOUCH_ENABLED){this.element.removeEventListener('touchstart',this._setDomTarget,true)}this.element.removeEventListener('mousedown',this._setDomTarget,true)},remove:function(){this._detachEvent();this.element=this.style=this.targetNode=null}});z.DomlessManager=z.Class.create({initialize:function(a){this._domRef=[];this.targetNode=a},_register:function(a,b){var i=this._domRef.indexOf(b);var c;if(a instanceof Array){if(i===-1){Array.prototype.push.apply(this._domRef,a)}else{Array.prototype.splice.apply(this._domRef,[i,0].concat(a))}}else{if(i===-1){this._domRef.push(a)}else{this._domRef.splice(i,0,a)}}},getNextManager:function(a){var i=this.targetNode.parentNode.childNodes.indexOf(a.targetNode);if(i!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[i+1]._domManager}else{return null}},getDomElement:function(){var b=[];this.targetNode.childNodes.forEach(function(a){b=b.concat(a._domManager.getDomElement())});return b},getDomElementAsNext:function(){if(this._domRef.length){return this._domRef[0]}else{var a=this.getNextManager(this);if(a){return a.element}else{return null}}},addManager:function(a,b){var c=this.targetNode.parentNode;if(c){if(b===null){b=this.getNextManager(this)}if(c instanceof z.Scene){c._layers.Dom._domManager.addManager(a,b)}else{c._domManager.addManager(a,b)}}var d=b?b.getDomElementAsNext():null;this._register(a.getDomElement(),d);this.setLayer(this.layer)},removeManager:function(a){var b;var i=this._domRef.indexOf(a.element);if(i!==-1){b=this._domRef[i];b.parentNode.removeChild(b);this._domRef.splice(i,1)}this.setLayer(this.layer)},setLayer:function(a){this.layer=a;var b=this.targetNode;var c;if(b.childNodes){for(var i=0,l=b.childNodes.length;i<l;i++){c=b.childNodes[i]._domManager;if(c){c.setLayer(a)}}}},render:function(a){var b=z.Matrix.instance;var c=b.stack;var d=this.targetNode;var e=[];b.makeTransformMatrix(d,e);b.multiply(c[c.length-1],e,e);b.multiply(a,e,a);d._matrix=a;var f=(typeof d._originX==='number')?d._originX:d.width/2||0;var g=(typeof d._originY==='number')?d._originY:d.height/2||0;var h=[f,g];b.multiplyVec(e,h,h);d._offsetX=h[0]-f;d._offsetY=h[1]-g;c.push(e)},remove:function(){this._domRef=[];this.targetNode=null}});z.DomLayer=z.Class.create(z.Group,{initialize:function(){var g=z.Core.instance;z.Group.call(this);this._touchEventTarget=null;this._element=document.createElement('div');this._element.style.position='absolute';this._domManager=new z.DomManager(this,this._element);this._domManager.layer=this;this.width=g.width;this.height=g.height;var h=[z.Event.TOUCH_START,z.Event.TOUCH_MOVE,z.Event.TOUCH_END];h.forEach(function(a){this.addEventListener(a,function(e){if(this._scene){this._scene.dispatchEvent(e)}})},this);var i=function(e){var a=e.node;var b=e.next;var c=e.target;var d=b?b._domManager:null;z.DomLayer._attachDomManager(a,i,j);c._domManager.addManager(a._domManager,d);var f=new z.Event(z.Event.RENDER);a._dirty=true;c._domManager.layer._rendering(a,f)};var j=function(e){var a=e.node;var b=e.target;b._domManager.removeManager(a._domManager);z.DomLayer._detachDomManager(a,i,j)};this.addEventListener('childremoved',j);this.addEventListener('childadded',i)},width:{get:function(){return this._width},set:function(a){this._width=a;this._element.style.width=a+'px'}},height:{get:function(){return this._height},set:function(a){this._height=a;this._element.style.height=a+'px'}},addChild:function(a){this.childNodes.push(a);a.parentNode=this;var b=new z.Event('childadded');b.node=a;b.next=null;this.dispatchEvent(b);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var c=new z.Event('addedtoscene');a.dispatchEvent(c)}},insertBefore:function(a,b){var i=this.childNodes.indexOf(b);if(i!==-1){this.childNodes.splice(i,0,a);a.parentNode=this;var c=new z.Event('childadded');c.node=a;c.next=b;this.dispatchEvent(c);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var d=new z.Event('addedtoscene');a.dispatchEvent(d)}}else{this.addChild(a)}},_startRendering:function(){this.addEventListener('exitframe',this._onexitframe);this._onexitframe()},_stopRendering:function(){this.removeEventListener('exitframe',this._onexitframe);this._onexitframe()},_onexitframe:function(){this._rendering(this,new z.Event(z.Event.RENDER))},_rendering:function(a,e,b){var c;if(!b){b=[1,0,0,1,0,0]}a.dispatchEvent(e);a._domManager.render(b);if(a.childNodes){for(var i=0,l=a.childNodes.length;i<l;i++){c=a.childNodes[i];this._rendering(c,e,b.slice())}}if(a._domManager instanceof z.DomlessManager){z.Matrix.instance.stack.pop()}a._dirty=false},_determineEventTarget:function(){var a=this._touchEventTarget;this._touchEventTarget=null;return(a===this)?null:a}});z.DomLayer._attachDomManager=function(a,b,c){var d;if(!a._domManager){a.addEventListener('childadded',b);a.addEventListener('childremoved',c);if(a instanceof z.Group){a._domManager=new z.DomlessManager(a)}else{if(a._element){a._domManager=new z.DomManager(a,a._element)}else{a._domManager=new z.DomManager(a,'div')}}}if(a.childNodes){for(var i=0,l=a.childNodes.length;i<l;i++){d=a.childNodes[i];z.DomLayer._attachDomManager(d,b,c);a._domManager.addManager(d._domManager,null)}}};z.DomLayer._detachDomManager=function(a,b,c){var d;a.removeEventListener('childadded',b);a.removeEventListener('childremoved',c);if(a.childNodes){for(var i=0,l=a.childNodes.length;i<l;i++){d=a.childNodes[i];a._domManager.removeManager(d._domManager,null);z.DomLayer._detachDomManager(d,b,c)}}a._domManager.remove();delete a._domManager};z.CanvasLayer=z.Class.create(z.Group,{initialize:function(){var f=z.Core.instance;z.Group.call(this);this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:'#000000'};this._cvsCache.layer=this;this._element=document.createElement('canvas');this._element.style.position='absolute';this._element.style.left=this._element.style.top='0px';this._detect=document.createElement('canvas');this._detect.style.position='absolute';this._lastDetected=0;this.context=this._element.getContext('2d');this._dctx=this._detect.getContext('2d');this._colorManager=new z.DetectColorManager(16,256);this.width=f.width;this.height=f.height;var g=[z.Event.TOUCH_START,z.Event.TOUCH_MOVE,z.Event.TOUCH_END];g.forEach(function(a){this.addEventListener(a,function(e){if(this._scene){this._scene.dispatchEvent(e)}})},this);var h=function(e){var a=e.node;var b=e.target;var c;if(b instanceof z.CanvasLayer){c=b._scene._layers.Canvas}else{c=b.scene._layers.Canvas}z.CanvasLayer._attachCache(a,c,h,i);var d=new z.Event(z.Event.RENDER);if(b._dirty){b._updateCoordinate()}a._dirty=true;z.Matrix.instance.stack.push(b._matrix);z.CanvasRenderer.instance.render(c.context,a,d);z.Matrix.instance.stack.pop(b._matrix)};var i=function(e){var a=e.node;var b=e.target;var c;if(b instanceof z.CanvasLayer){c=b._scene._layers.Canvas}else{c=b.scene._layers.Canvas}z.CanvasLayer._detachCache(a,c,h,i)};this.addEventListener('childremoved',i);this.addEventListener('childadded',h)},width:{get:function(){return this._width},set:function(a){this._width=a;this._element.width=this._detect.width=a}},height:{get:function(){return this._height},set:function(a){this._height=a;this._element.height=this._detect.height=a}},addChild:function(a){this.childNodes.push(a);a.parentNode=this;var b=new z.Event('childadded');b.node=a;b.next=null;this.dispatchEvent(b);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var c=new z.Event('addedtoscene');a.dispatchEvent(c)}},insertBefore:function(a,b){var i=this.childNodes.indexOf(b);if(i!==-1){this.childNodes.splice(i,0,a);a.parentNode=this;var c=new z.Event('childadded');c.node=a;c.next=b;this.dispatchEvent(c);a.dispatchEvent(new z.Event('added'));if(this.scene){a.scene=this.scene;var d=new z.Event('addedtoscene');a.dispatchEvent(d)}}else{this.addChild(a)}},_startRendering:function(){this.addEventListener('exitframe',this._onexitframe);this._onexitframe(new z.Event(z.Event.RENDER))},_stopRendering:function(){this.removeEventListener('render',this._onexitframe);this._onexitframe(new z.Event(z.Event.RENDER))},_onexitframe:function(){var a=z.Core.instance;var b=this.context;b.clearRect(0,0,a.width,a.height);var c=new z.Event(z.Event.RENDER);z.CanvasRenderer.instance.render(b,this,c)},_determineEventTarget:function(e){return this._getEntityByPosition(e.x,e.y)},_getEntityByPosition:function(x,y){var a=z.Core.instance;var b=this._dctx;if(this._lastDetected<a.frame){b.clearRect(0,0,this.width,this.height);z.CanvasRenderer.instance.detectRender(b,this);this._lastDetected=a.frame}var c=b.getImageData(x,y,1,1).data;return this._colorManager.getSpriteByColor(c)}});z.CanvasLayer._attachCache=function(a,b,c,d){var e;if(!a._cvsCache){a._cvsCache={};a._cvsCache.matrix=[1,0,0,1,0,0];a._cvsCache.detectColor='rgba('+b._colorManager.attachDetectColor(a)+')';a.addEventListener('childadded',c);a.addEventListener('childremoved',d)}if(a.childNodes){for(var i=0,l=a.childNodes.length;i<l;i++){e=a.childNodes[i];z.CanvasLayer._attachCache(e,b,c,d)}}};z.CanvasLayer._detachCache=function(a,b,c,d){var e;if(a._cvsCache){b._colorManager.detachDetectColor(a);a.removeEventListener('childadded',c);a.removeEventListener('childremoved',d);delete a._cvsCache}if(a.childNodes){for(var i=0,l=a.childNodes.length;i<l;i++){e=a.childNodes[i];z.CanvasLayer._detachCache(e,b,c,d)}}};z.CanvasRenderer=z.Class.create({render:function(a,b,e){var c,height,child;a.save();b.dispatchEvent(e);this.transform(a,b);if(typeof b._visible==='undefined'||b._visible){c=b.width;height=b.height;if(b.compositeOperation){a.globalCompositeOperation=b.compositeOperation}a.globalAlpha=(typeof b._opacity==='number')?b._opacity:1.0;if(b._backgroundColor){a.fillStyle=b._backgroundColor;a.fillRect(0,0,c,height)}if(b.cvsRender){b.cvsRender(a)}if(z.Core.instance._debug&&b._debugColor){a.strokeStyle=b._debugColor;a.strokeRect(0,0,c,height)}if(b._clipping){a.beginPath();a.rect(0,0,c,height);a.clip()}if(b.childNodes){for(var i=0,l=b.childNodes.length;i<l;i++){child=b.childNodes[i];this.render(a,child,e)}}}a.restore();z.Matrix.instance.stack.pop()},detectRender:function(a,b){var c,height,child;if(typeof b._visible==='undefined'||b._visible){c=b.width;height=b.height;a.save();this.transform(a,b);a.fillStyle=b._cvsCache.detectColor;if(b._touchEnabled){if(b.detectRender){b.detectRender(a)}else{a.fillRect(0,0,c,height)}}if(b._clipping){a.beginPath();a.rect(0,0,c,height);a.clip()}if(b.childNodes){for(var i=0,l=b.childNodes.length;i<l;i++){child=b.childNodes[i];this.detectRender(a,child)}}a.restore();z.Matrix.instance.stack.pop()}},transform:function(a,b){var c=z.Matrix.instance;var d=c.stack;var e,ox,oy,vec;if(b._dirty){c.makeTransformMatrix(b,b._cvsCache.matrix);e=[];c.multiply(d[d.length-1],b._cvsCache.matrix,e);b._matrix=e;ox=(typeof b._originX==='number')?b._originX:b._width/2||0;oy=(typeof b._originY==='number')?b._originY:b._height/2||0;vec=[ox,oy];c.multiplyVec(e,vec,vec);b._offsetX=vec[0]-ox;b._offsetY=vec[1]-oy;b._dirty=false}else{e=b._matrix}d.push(e);a.setTransform.apply(a,e)}});z.CanvasRenderer.instance=new z.CanvasRenderer();z.Scene=z.Class.create(z.Group,{initialize:function(){var c=z.Core.instance;z.Group.call(this);this.scene=this;this._backgroundColor=null;this._element=document.createElement('div');this._element.style.position='absolute';this._element.style.overflow='hidden';this._element.style[z.ENV.VENDOR_PREFIX+'TransformOrigin']='0 0';this._layers={};this._layerPriority=[];this.addEventListener(z.Event.CHILD_ADDED,this._onchildadded);this.addEventListener(z.Event.CHILD_REMOVED,this._onchildremoved);this.addEventListener(z.Event.ENTER,this._onenter);this.addEventListener(z.Event.EXIT,this._onexit);var d=this;this._dispatchExitframe=function(){var a;for(var b in d._layers){a=d._layers[b];a.dispatchEvent(new z.Event(z.Event.EXIT_FRAME))}};this.addEventListener(z.Event.CORE_RESIZE,this._oncoreresize);this._oncoreresize(c)},x:{get:function(){return this._x},set:function(x){this._x=x;for(var a in this._layers){this._layers[a].x=x}}},y:{get:function(){return this._y},set:function(y){this._y=y;for(var a in this._layers){this._layers[a].y=y}}},width:{get:function(){return this._width},set:function(a){this._width=a;for(var b in this._layers){this._layers[b].width=a}}},height:{get:function(){return this._height},set:function(a){this._height=a;for(var b in this._layers){this._layers[b].height=a}}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;for(var b in this._layers){this._layers[b].rotation=a}}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;for(var b in this._layers){this._layers[b].scaleX=a}}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;for(var b in this._layers){this._layers[b].scaleY=a}}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=this._element.style.backgroundColor=a}},_oncoreresize:function(e){this._element.style.width=e.width+'px';this.width=e.width;this._element.style.height=e.height+'px';this.height=e.height;this._element.style[z.ENV.VENDOR_PREFIX+'Transform']='scale('+e.scale+')';for(var a in this._layers){this._layers[a].dispatchEvent(e)}},addLayer:function(a,i){var b=z.Core.instance;if(this._layers[a]){return}var c=new z[a+'Layer']();if(b.currentScene===this){c._startRendering()}this._layers[a]=c;var d=c._element;if(typeof i==='number'){var e=this._element.childNodes[i];if(e){this._element.insertBefore(d,e)}else{this._element.appendChild(d)}this._layerPriority.splice(i,0,a)}else{this._element.appendChild(d);this._layerPriority.push(a)}c._scene=this},_determineEventTarget:function(e){var a,target;for(var i=this._layerPriority.length-1;i>=0;i--){a=this._layers[this._layerPriority[i]];target=a._determineEventTarget(e);if(target){break}}if(!target){target=this}return target},_onchildadded:function(e){var a=e.node;var b=e.next;var c,i;if(a._element){c='Dom';i=1}else{c='Canvas';i=0}if(!this._layers[c]){this.addLayer(c,i)}a._layer=this._layers[c];this._layers[c].insertBefore(a,b);a.parentNode=this},_onchildremoved:function(e){var a=e.node;a._layer.removeChild(a);a._layer=null},_onenter:function(){for(var a in this._layers){this._layers[a]._startRendering()}z.Core.instance.addEventListener('exitframe',this._dispatchExitframe)},_onexit:function(){for(var a in this._layers){this._layers[a]._stopRendering()}z.Core.instance.removeEventListener('exitframe',this._dispatchExitframe)}});z.LoadingScene=z.Class.create(z.Scene,{initialize:function(){z.Scene.call(this);this.backgroundColor='#000';var b=this.width*0.4|0;var c=this.width*0.05|0;var d=b*0.03|0;var f=new z.Sprite(b,c);f.disableCollection();f.x=(this.width-b)/2;f.y=(this.height-c)/2;var g=new z.Surface(b,c);g.context.fillStyle='#fff';g.context.fillRect(0,0,b,c);g.context.fillStyle='#000';g.context.fillRect(d,d,b-d*2,c-d*2);f.image=g;var h=0,_progress=0;this.addEventListener('progress',function(e){h=e.loaded/e.total*1.0});f.addEventListener('enterframe',function(){_progress*=0.9;_progress+=h*0.1;g.context.fillStyle='#fff';g.context.fillRect(d,0,(b-d*2)*_progress,c)});this.addChild(f);this.addEventListener('load',function(e){var a=z.Core.instance;a.removeScene(a.loadingScene);a.dispatchEvent(e)})}});z.CanvasScene=z.Class.create(z.Scene,{initialize:function(){z.Scene.call(this);this.addLayer('Canvas')},_determineEventTarget:function(e){var a=this._layers.Canvas._determineEventTarget(e);if(!a){a=this}return a},_onchildadded:function(e){var a=e.node;var b=e.next;a._layer=this._layers.Canvas;this._layers.Canvas.insertBefore(a,b)},_onenter:function(){this._layers.Canvas._startRendering();z.Core.instance.addEventListener('exitframe',this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering();z.Core.instance.removeEventListener('exitframe',this._dispatchExitframe)}});z.DOMScene=z.Class.create(z.Scene,{initialize:function(){z.Scene.call(this);this.addLayer('Dom')},_determineEventTarget:function(e){var a=this._layers.Dom._determineEventTarget(e);if(!a){a=this}return a},_onchildadded:function(e){var a=e.node;var b=e.next;a._layer=this._layers.Dom;this._layers.Dom.insertBefore(a,b)},_onenter:function(){this._layers.Dom._startRendering();z.Core.instance.addEventListener('exitframe',this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering();z.Core.instance.removeEventListener('exitframe',this._dispatchExitframe)}});z.Surface=z.Class.create(z.EventTarget,{initialize:function(c,d){z.EventTarget.call(this);var e=z.Core.instance;this.width=c;this.height=d;this.context=null;var f='enchant-surface'+e._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext('2d',f,c,d);this._element=this.context.canvas;this._css='-webkit-canvas('+f+')';var g=this.context}else if(document.mozSetImageElement){this._element=document.createElement('canvas');this._element.width=c;this._element.height=d;this._css='-moz-element(#'+f+')';this.context=this._element.getContext('2d');document.mozSetImageElement(f,this._element)}else{this._element=document.createElement('canvas');this._element.width=c;this._element.height=d;this._element.style.position='absolute';this.context=this._element.getContext('2d');z.ENV.CANVAS_DRAWING_METHODS.forEach(function(a){var b=this.context[a];this.context[a]=function(){b.apply(this,arguments);this._dirty=true}},this)}},getPixel:function(x,y){return this.context.getImageData(x,y,1,1).data},setPixel:function(x,y,r,g,b,a){var c=this.context.createImageData(1,1);c.data[0]=r;c.data[1]=g;c.data[2]=b;c.data[3]=a;this.context.putImageData(c,x,y)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(a){a=a._element;if(arguments.length===1){this.context.drawImage(a,0,0)}else{var b=arguments;b[0]=a;this.context.drawImage.apply(this.context,b)}},clone:function(){var a=new z.Surface(this.width,this.height);a.draw(this);return a},toDataURL:function(){var a=this._element.src;if(a){if(a.slice(0,5)==='data:'){return a}else{return this.clone().toDataURL()}}else{return this._element.toDataURL()}}});z.Surface.load=function(a,b,c){var d=new Image();var f=Object.create(z.Surface.prototype,{context:{value:null},_css:{value:'url('+a+')'},_element:{value:d}});z.EventTarget.call(f);c=c||function(){};f.addEventListener('load',b);f.addEventListener('error',c);d.onerror=function(){var e=new z.Event(z.Event.ERROR);e.message='Cannot load an asset: '+d.src;z.Core.instance.dispatchEvent(e);f.dispatchEvent(e)};d.onload=function(){f.width=d.width;f.height=d.height;f.dispatchEvent(new z.Event('load'))};d.src=a;return f};z.Surface._staticCanvas2DContext=document.createElement('canvas').getContext('2d');z.Surface._getPattern=function(a,b){if(!a._pattern||b){a._pattern=this._staticCanvas2DContext.createPattern(a._element,'repeat')}return a._pattern};if(u.Deferred){z.Deferred=u.Deferred}else{z.Deferred=z.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null;this._tail=this},next:function(a){var q=new z.Deferred();q._succ=a;return this._add(q)},error:function(a){var q=new z.Deferred();q._fail=a;return this._add(q)},_add:function(a){this._tail._next=a;this._tail=a;return this},call:function(a){var b;var c=this;while(c&&!c._succ){c=c._next}if(!(c instanceof z.Deferred)){return}try{b=c._succ(a)}catch(e){return c.fail(e)}if(b instanceof z.Deferred){z.Deferred._insert(c,b)}else if(c._next instanceof z.Deferred){c._next.call(b)}},fail:function(a){var b,err,queue=this;while(queue&&!queue._fail){queue=queue._next}if(queue instanceof z.Deferred){b=queue._fail(a);queue.call(b)}else if(a instanceof Error){throw a;}else{err=new Error('failed in Deferred');err.arg=a;throw err;}}});z.Deferred._insert=function(a,b){if(a._next instanceof z.Deferred){b._tail._next=a._next}a._next=b};z.Deferred.next=function(a){var q=new z.Deferred().next(a);q._id=setTimeout(function(){q.call()},0);return q};z.Deferred.parallel=function(d){var q=new z.Deferred();q._id=setTimeout(function(){q.call()},0);var e=0;var f=(d instanceof Array)?[]:{};var p=new z.Deferred();for(var g in d){if(d.hasOwnProperty(g)){e++;(function(b,c){b.next(function(a){e--;f[c]=a;if(e<=0){p.call(f)}}).error(function(a){p.fail(a)});if(typeof b._id==='number'){clearTimeout(b._id)}b._id=setTimeout(function(){b.call()},0)}(d[g],g))}}if(!e){p._id=setTimeout(function(){p.call(f)},0)}return q.next(function(){return p})}}z.DOMSound=z.Class.create(z.EventTarget,{initialize:function(){z.EventTarget.call(this);this.duration=0;throw new Error("Illegal Constructor");},play:function(){if(this._element){this._element.play()}},pause:function(){if(this._element){this._element.pause()}},stop:function(){this.pause();this.currentTime=0},clone:function(){var a;if(this._element instanceof Audio){a=Object.create(z.DOMSound.prototype,{_element:{value:this._element.cloneNode(false)},duration:{value:this.duration}})}else if(z.ENV.USE_FLASH_SOUND){return this}else{a=Object.create(z.DOMSound.prototype)}z.EventTarget.call(a);return a},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(a){if(this._element){this._element.currentTime=a}}},volume:{get:function(){return this._element?this._element.volume:1},set:function(a){if(this._element){this._element.volume=a}}}});z.DOMSound.load=function(b,c,d,f){if(c==null){var g=z.Core.findExt(b);if(g){c='audio/'+g}else{c=''}}c=c.replace('mp3','mpeg').replace('m4a','mp4');d=d||function(){};f=f||function(){};var h=Object.create(z.DOMSound.prototype);z.EventTarget.call(h);h.addEventListener('load',d);h.addEventListener('error',f);var i=new Audio();if(!z.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&z.ENV.VENDOR_PREFIX==='webkit'&&z.ENV.TOUCH_ENABLED){u.setTimeout(function(){h.dispatchEvent(new z.Event('load'))},0)}else{if(!z.ENV.USE_FLASH_SOUND&&i.canPlayType(c)){i.addEventListener('canplaythrough',function canplay(){h.duration=i.duration;h.dispatchEvent(new z.Event('load'));i.removeEventListener('canplaythrough',canplay)},false);i.src=b;i.load();i.autoplay=false;i.onerror=function(){var e=new z.Event(z.Event.ERROR);e.message='Cannot load an asset: '+i.src;z.Core.instance.dispatchEvent(e);h.dispatchEvent(e)};h._element=i}else if(c==='audio/mpeg'){var j=document.createElement('embed');var k='enchant-audio'+z.Core.instance._soundID++;j.width=j.height=1;j.name=k;j.src='sound.swf?id='+k+'&src='+b;j.allowscriptaccess='always';j.style.position='absolute';j.style.left='-1px';h.addEventListener('load',function(){Object.defineProperties(j,{currentTime:{get:function(){return j.getCurrentTime()},set:function(a){j.setCurrentTime(a)}},volume:{get:function(){return j.getVolume()},set:function(a){j.setVolume(a)}}});h._element=j;h.duration=j.getDuration()});z.Core.instance._element.appendChild(j);z.DOMSound[k]=h}else{u.setTimeout(function(){h.dispatchEvent(new z.Event('load'))},0)}}return h};u.AudioContext=u.AudioContext||u.webkitAudioContext||u.mozAudioContext||u.msAudioContext||u.oAudioContext;z.WebAudioSound=z.Class.create(z.EventTarget,{initialize:function(){if(!u.AudioContext){throw new Error("This browser does not support WebAudio API.");}z.EventTarget.call(this);this.context=z.WebAudioSound.audioContext;this.src=this.context.createBufferSource();this.buffer=null;this._volume=1;this._currentTime=0;this._state=0;this.connectTarget=z.WebAudioSound.destination},play:function(a){if(this._state===1&&!a){this.src.disconnect(this.connectTarget)}if(this._state!==2){this._currentTime=0}var b=this._currentTime;var c=this.context;this.src=c.createBufferSource();if(c.createGain!=null){this._gain=c.createGain()}else{this._gain=c.createGainNode()}this.src.buffer=this.buffer;this._gain.gain.value=this._volume;this.src.connect(this._gain);this._gain.connect(this.connectTarget);if(this.src.start!=null){this.src.start(0,b,this.buffer.duration-b-1.192e-7)}else{this.src.noteGrainOn(0,b,this.buffer.duration-b-1.192e-7)}this._startTime=c.currentTime-this._currentTime;this._state=1},pause:function(){var a=this.currentTime;if(a===this.duration){return}if(this.src.stop!=null){this.src.stop(0)}else{this.src.noteOff(0)}this._currentTime=a;this._state=2},stop:function(){if(this.src.stop!=null){this.src.stop(0)}else{this.src.noteOff(0)}this._state=0},clone:function(){var a=new z.WebAudioSound();a.buffer=this.buffer;return a},duration:{get:function(){if(this.buffer){return this.buffer.duration}else{return 0}}},volume:{get:function(){return this._volume},set:function(a){a=Math.max(0,Math.min(1,a));this._volume=a;if(this.src){this._gain.gain.value=a}}},currentTime:{get:function(){return Math.max(0,Math.min(this.duration,this.src.context.currentTime-this._startTime))},set:function(a){this._currentTime=a;if(this._state!==2){this.play(false)}}}});z.WebAudioSound.load=function(b,c,d,f){var g=(new Audio()).canPlayType(c);var h=new z.WebAudioSound();d=d||function(){};f=f||function(){};h.addEventListener(z.Event.LOAD,d);h.addEventListener(z.Event.ERROR,f);function dispatchErrorEvent(){var e=new z.Event(z.Event.ERROR);e.message='Cannot load an asset: '+b;z.Core.instance.dispatchEvent(e);h.dispatchEvent(e)}var i,xhr;if(g==='maybe'||g==='probably'){i=z.WebAudioSound.audioContext;xhr=new XMLHttpRequest();xhr.open('GET',b,true);xhr.responseType='arraybuffer';xhr.onload=function(){i.decodeAudioData(xhr.response,function(a){h.buffer=a;h.dispatchEvent(new z.Event(z.Event.LOAD))},dispatchErrorEvent)};xhr.onerror=dispatchErrorEvent;xhr.send(null)}else{setTimeout(dispatchErrorEvent,50)}return h};if(u.AudioContext){z.WebAudioSound.audioContext=new u.AudioContext();z.WebAudioSound.destination=z.WebAudioSound.audioContext.destination}z.Sound=u.AudioContext&&z.ENV.USE_WEBAUDIO?z.WebAudioSound:z.DOMSound;z.Easing={LINEAR:function(t,b,c,d){return c*t/d+b},SWING:function(t,b,c,d){return c*(0.5-Math.cos(((t/d)*Math.PI))/2)+b},QUAD_EASEIN:function(t,b,c,d){return c*(t/=d)*t+b},QUAD_EASEOUT:function(t,b,c,d){return-c*(t/=d)*(t-2)+b},QUAD_EASEINOUT:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t+b}return-c/2*((--t)*(t-2)-1)+b},CUBIC_EASEIN:function(t,b,c,d){return c*(t/=d)*t*t+b},CUBIC_EASEOUT:function(t,b,c,d){return c*((t=t/d-1)*t*t+1)+b},CUBIC_EASEINOUT:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t+b}return c/2*((t-=2)*t*t+2)+b},QUART_EASEIN:function(t,b,c,d){return c*(t/=d)*t*t*t+b},QUART_EASEOUT:function(t,b,c,d){return-c*((t=t/d-1)*t*t*t-1)+b},QUART_EASEINOUT:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t*t+b}return-c/2*((t-=2)*t*t*t-2)+b},QUINT_EASEIN:function(t,b,c,d){return c*(t/=d)*t*t*t*t+b},QUINT_EASEOUT:function(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b},QUINT_EASEINOUT:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t*t*t+b}return c/2*((t-=2)*t*t*t*t+2)+b},SIN_EASEIN:function(t,b,c,d){return-c*Math.cos(t/d*(Math.PI/2))+c+b},SIN_EASEOUT:function(t,b,c,d){return c*Math.sin(t/d*(Math.PI/2))+b},SIN_EASEINOUT:function(t,b,c,d){return-c/2*(Math.cos(Math.PI*t/d)-1)+b},CIRC_EASEIN:function(t,b,c,d){return-c*(Math.sqrt(1-(t/=d)*t)-1)+b},CIRC_EASEOUT:function(t,b,c,d){return c*Math.sqrt(1-(t=t/d-1)*t)+b},CIRC_EASEINOUT:function(t,b,c,d){if((t/=d/2)<1){return-c/2*(Math.sqrt(1-t*t)-1)+b}return c/2*(Math.sqrt(1-(t-=2)*t)+1)+b},ELASTIC_EASEIN:function(t,b,c,d,a,p){if(t===0){return b}if((t/=d)===1){return b+c}if(!p){p=d*0.3}var s;if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b},ELASTIC_EASEOUT:function(t,b,c,d,a,p){if(t===0){return b}if((t/=d)===1){return b+c}if(!p){p=d*0.3}var s;if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}return(a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b)},ELASTIC_EASEINOUT:function(t,b,c,d,a,p){if(t===0){return b}if((t/=d/2)===2){return b+c}if(!p){p=d*(0.3*1.5)}var s;if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}if(t<1){return-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b}return a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*0.5+c+b},BOUNCE_EASEOUT:function(t,b,c,d){if((t/=d)<(1/2.75)){return c*(7.5625*t*t)+b}else if(t<(2/2.75)){return c*(7.5625*(t-=(1.5/2.75))*t+0.75)+b}else if(t<(2.5/2.75)){return c*(7.5625*(t-=(2.25/2.75))*t+0.9375)+b}else{return c*(7.5625*(t-=(2.625/2.75))*t+0.984375)+b}},BOUNCE_EASEIN:function(t,b,c,d){return c-z.Easing.BOUNCE_EASEOUT(d-t,0,c,d)+b},BOUNCE_EASEINOUT:function(t,b,c,d){if(t<d/2){return z.Easing.BOUNCE_EASEIN(t*2,0,c,d)*0.5+b}else{return z.Easing.BOUNCE_EASEOUT(t*2-d,0,c,d)*0.5+c*0.5+b}},BACK_EASEIN:function(t,b,c,d,s){if(s===v){s=1.70158}return c*(t/=d)*t*((s+1)*t-s)+b},BACK_EASEOUT:function(t,b,c,d,s){if(s===v){s=1.70158}return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},BACK_EASEINOUT:function(t,b,c,d,s){if(s===v){s=1.70158}if((t/=d/2)<1){return c/2*(t*t*(((s*=(1.525))+1)*t-s))+b}return c/2*((t-=2)*t*(((s*=(1.525))+1)*t+s)+2)+b},EXPO_EASEIN:function(t,b,c,d){return(t===0)?b:c*Math.pow(2,10*(t/d-1))+b},EXPO_EASEOUT:function(t,b,c,d){return(t===d)?b+c:c*(-Math.pow(2,-10*t/d)+1)+b},EXPO_EASEINOUT:function(t,b,c,d){if(t===0){return b}if(t===d){return b+c}if((t/=d/2)<1){return c/2*Math.pow(2,10*(t-1))+b}return c/2*(-Math.pow(2,-10*--t)+2)+b}};z.ActionEventTarget=z.Class.create(z.EventTarget,{initialize:function(){z.EventTarget.apply(this,arguments)},dispatchEvent:function(e){var a;if(this.node){a=this.node;e.target=a;e.localX=e.x-a._offsetX;e.localY=e.y-a._offsetY}else{this.node=null}if(this['on'+e.type]!=null){this['on'+e.type].call(a,e)}var b=this._listeners[e.type];if(b!=null){b=b.slice();for(var i=0,len=b.length;i<len;i++){b[i].call(a,e)}}}});z.Timeline=z.Class.create(z.EventTarget,{initialize:function(a){z.EventTarget.call(this);this.node=a;this.queue=[];this.paused=false;this.looped=false;this.isFrameBased=true;this._parallel=null;this._activated=false;this.addEventListener(z.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){if(this._activated){this._activated=false;this.node.removeEventListener('enterframe',this._nodeEventListener)}},_activateTimeline:function(){if(!this._activated&&!this.paused){this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}},setFrameBased:function(){this.isFrameBased=true},setTimeBased:function(){this.isFrameBased=false},next:function(a){var e,action=this.queue.shift();if(action){e=new z.Event("actionend");e.timeline=this;action.dispatchEvent(e)}if(this.queue.length===0){this._activated=false;this.node.removeEventListener('enterframe',this._nodeEventListener);return}if(this.looped){e=new z.Event("removedfromtimeline");e.timeline=this;action.dispatchEvent(e);action.frame=0;this.add(action)}else{e=new z.Event("removedfromtimeline");e.timeline=this;action.dispatchEvent(e)}if(a>0||(this.queue[0]&&this.queue[0].time===0)){var b=new z.Event("enterframe");b.elapsed=a;this.dispatchEvent(b)}},tick:function(a){if(this.paused){return}if(this.queue.length>0){var b=this.queue[0];if(b.frame===0){var f;f=new z.Event("actionstart");f.timeline=this;b.dispatchEvent(f)}var e=new z.Event("actiontick");e.timeline=this;if(this.isFrameBased){e.elapsed=1}else{e.elapsed=a.elapsed}b.dispatchEvent(e)}},add:function(a){if(!this._activated){var b=this;this._nodeEventListener=function(e){b.dispatchEvent(e)};this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}if(this._parallel){this._parallel.actions.push(a);this._parallel=null}else{this.queue.push(a)}a.frame=0;var e=new z.Event("addedtotimeline");e.timeline=this;a.dispatchEvent(e);e=new z.Event("actionadded");e.action=a;this.dispatchEvent(e);return this},action:function(a){return this.add(new z.Action(a))},tween:function(a){return this.add(new z.Tween(a))},clear:function(){var e=new z.Event("removedfromtimeline");e.timeline=this;for(var i=0,len=this.queue.length;i<len;i++){this.queue[i].dispatchEvent(e)}this.queue=[];this._deactivateTimeline();return this},skip:function(a){var b=new z.Event("enterframe");if(this.isFrameBased){b.elapsed=1}else{b.elapsed=a;a=1}while(a--){this.dispatchEvent(b)}return this},pause:function(){if(!this.paused){this.paused=true;this._deactivateTimeline()}return this},resume:function(){if(this.paused){this.paused=false;this._activateTimeline()}return this},loop:function(){this.looped=true;return this},unloop:function(){this.looped=false;return this},delay:function(a){this.add(new z.Action({time:a}));return this},wait:function(a){return this},then:function(b){var c=this;this.add(new z.Action({onactiontick:function(a){b.call(c.node)},time:0}));return this},exec:function(a){this.then(a)},cue:function(a){var b=0;for(var c in a){if(a.hasOwnProperty(c)){this.delay(c-b);this.then(a[c]);b=c}}},repeat:function(b,c){this.add(new z.Action({onactiontick:function(a){b.call(this)},time:c}));return this},and:function(){var a=this.queue.pop();if(a instanceof z.ParallelAction){this._parallel=a;this.queue.push(a)}else{var b=new z.ParallelAction();b.actions.push(a);this.queue.push(b);this._parallel=b}return this},or:function(){return this},doAll:function(a){return this},waitAll:function(){return this},waitUntil:function(b){var c=this;this.add(new z.Action({onactionstart:b,onactiontick:function(a){if(b.call(this)){c.next()}}}));return this},fadeTo:function(a,b,c){this.tween({opacity:a,time:b,easing:c});return this},fadeIn:function(a,b){return this.fadeTo(1,a,b)},fadeOut:function(a,b){return this.fadeTo(0,a,b)},moveTo:function(x,y,a,b){return this.tween({x:x,y:y,time:a,easing:b})},moveX:function(x,a,b){return this.tween({x:x,time:a,easing:b})},moveY:function(y,a,b){return this.tween({y:y,time:a,easing:b})},moveBy:function(x,y,a,b){return this.tween({x:function(){return this.x+x},y:function(){return this.y+y},time:a,easing:b})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this)})},scaleTo:function(a,b,c){if(typeof c==="number"){return this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:a,scaleY:a,time:b,easing:c})},scaleBy:function(a,b,c){if(typeof c==="number"){return this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:function(){return this.scaleX*a},scaleY:function(){return this.scaleY*a},time:b,easing:c})},rotateTo:function(a,b,c){return this.tween({rotation:a,time:b,easing:c})},rotateBy:function(a,b,c){return this.tween({rotation:function(){return this.rotation+a},time:b,easing:c})}});z.Action=z.Class.create(z.ActionEventTarget,{initialize:function(c){z.ActionEventTarget.call(this);this.time=null;this.frame=0;for(var d in c){if(c.hasOwnProperty(d)){if(c[d]!=null){this[d]=c[d]}}}var e=this;this.timeline=null;this.node=null;this.addEventListener(z.Event.ADDED_TO_TIMELINE,function(a){e.timeline=a.timeline;e.node=a.timeline.node;e.frame=0});this.addEventListener(z.Event.REMOVED_FROM_TIMELINE,function(){e.timeline=null;e.node=null;e.frame=0});this.addEventListener(z.Event.ACTION_TICK,function(a){var b=e.time-(e.frame+a.elapsed);if(e.time!=null&&b<=0){e.frame=e.time;a.timeline.next(-b)}else{e.frame+=a.elapsed}})}});z.ParallelAction=z.Class.create(z.Action,{initialize:function(d){z.Action.call(this,d);var f=this.timeline;var g=this.node;this.actions=[];this.endedActions=[];var h=this;this.addEventListener(z.Event.ACTION_START,function(a){for(var i=0,len=h.actions.length;i<len;i++){h.actions[i].dispatchEvent(a)}});this.addEventListener(z.Event.ACTION_TICK,function(c){var i,len,f={next:function(a){var b=h.actions[i];h.actions.splice(i--,1);len=h.actions.length;h.endedActions.push(b);var e=new z.Event("actionend");e.timeline=this;b.dispatchEvent(e);e=new z.Event("removedfromtimeline");e.timeline=this;b.dispatchEvent(e)}};var e=new z.Event("actiontick");e.timeline=f;e.elapsed=c.elapsed;for(i=0,len=h.actions.length;i<len;i++){h.actions[i].dispatchEvent(e)}if(h.actions.length===0){c.timeline.next()}});this.addEventListener(z.Event.ADDED_TO_TIMELINE,function(a){for(var i=0,len=h.actions.length;i<len;i++){h.actions[i].dispatchEvent(a)}});this.addEventListener(z.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions;this.endedActions=[]})}});z.Tween=z.Class.create(z.Action,{initialize:function(e){var f={};var g={};z.Action.call(this,e);if(this.easing==null){this.easing=function(t,b,c,d){return c*t/d+b}}var h=this;this.addEventListener(z.Event.ACTION_START,function(){var a=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var b in e){if(e.hasOwnProperty(b)){var c;if(typeof e[b]==="function"){c=e[b].call(h.node)}else{c=e[b]}if(a.indexOf(b)===-1){f[b]=h.node[b];g[b]=c}}}});this.addEventListener(z.Event.ACTION_TICK,function(a){var b=h.time===0?1:h.easing(Math.min(h.time,h.frame+a.elapsed),0,1,h.time)-h.easing(h.frame,0,1,h.time);for(var c in g){if(g.hasOwnProperty(c)){if(typeof this[c]==="undefined"){continue}h.node[c]+=(g[c]-f[c])*b;if(Math.abs(h.node[c])<10e-8){h.node[c]=0}}}})}})}(window));

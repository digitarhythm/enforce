#!/usr/bin/php
<?php
$ini = parse_ini_file("lib/config.ini", true);
$library = $ini['ENVIRON']['LIBRARY'];
$eftmp = dirname(__FILE__);
$compiler = "coffee";

// working directory
$TMPPROJ = preg_replace("/\s/i", "\ ", getcwd());

// check develop mode
if (!is_file("$TMPPROJ/index.php")) {
    echo "It does not become a development mode.\n";
    exit;
}

// enforce system directory
$ENF = preg_replace("/\s/i", "\ ", realpath("$eftmp/.."));
// working directory
$PROJ = preg_replace("/\s/i", "\ ", $TMPPROJ);

// directory make
exec("mkdir -p $PROJ/lib");
exec("mkdir -p $PROJ/media/picture");
exec("mkdir -p $PROJ/media/sound");
exec("mkdir -p $PROJ/media/model");
exec("mkdir -p $PROJ/src");
exec("mkdir -p $PROJ/plugins");
exec("mkdir -p $PROJ/extlib");
exec("mkdir -p $PROJ/sysobject");
exec("mkdir -p $PROJ/usrobject");

// system file copy
exec("cp -af $ENF/index.php $PROJ/");
exec("cp -af $ENF/extlib/* $PROJ/extlib/");
exec("cp -af $ENF/lib/*.png $PROJ/lib/");
exec("cp -af $ENF/media/sound/* $PROJ/media/sound/");
exec("cp -af $ENF/media/model/* $PROJ/media/model/");

exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/media/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/media/picture/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/media/sound/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/media/model/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/extlib/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/sysobject/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/usrobject/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/plugins/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noindexes $PROJ/lib/.htaccess > /dev/null");
exec("cp -af $ENF/lib/htaccess.noaccess  $PROJ/src/.htaccess > /dev/null");

// 共用ライブラリコンパイル
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/library.coffee");

exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/01_originObject.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/03_vanalogpad.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/04_vgamebutton.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/05_vgamepadcontrol.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/06_dispImageStrings.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/plugins/*.coffee");

// enchantライブラリ生成
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/02_stationary.enchant.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/07_main.enchant.coffee");

// tmlibライブラリ生成
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/02_stationary.tmlib.coffee");
exec("$compiler -o $PROJ/sysobject -bMc $ENF/lib/07_main.tmlib.coffee");
?>

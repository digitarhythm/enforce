#!/bin/bash

if [ -z ${1} ]; then
	exit
fi

if [ "${1}" = "-with-codit" ]; then
    CODIT=1
    PACKAGE=$2
elif [ -n ${2} ]; then
    if [ "${2}" = "-with-codit" ]; then
        CODIT=1
        PACKAGE=${1}
    else
        CODIT=0
        PACKAGE=${1}
    fi
else
    CODIT=0
    PACKAGE=${1}
fi

CWD=`pwd`
ENF=$(cd $(dirname $0)/..;pwd)
PROJ=$CWD/$PACKAGE

# 必要なディレクトリの作成
echo "Project Dcirectory:"$PROJ
mkdir -p $PROJ/lib
mkdir -p $PROJ/media
mkdir -p $PROJ/src
mkdir -p $PROJ/sysobject
mkdir -p $PROJ/usrobject
mkdir -p $PROJ/plugins
mkdir -p $PROJ/extlib

# フレームワークファイルのコピー
cp -af $ENF/index.php $PROJ/
cp -af $ENF/media/* $PROJ/media/
cp -af $ENF/src/enchantMain.coffee $PROJ/src/
cp -af $ENF/src/environ.coffee $PROJ/src/
cp -af $ENF/extlib/* $PROJ/extlib/
cp -af $ENF/lib/config.ini $PROJ/lib/
cp -af $ENF/lib/sqlite3.db $PROJ/lib/

# enforceバージョンの設定
echo "1.0" > $PROJ/lib/version

# エディターのコピー
if [ "${CODIT}" = "1" ]; then
    cp -af $ENF/codit $PROJ/
fi

# サンプルソースをコピー
cp -af $ENF/src/bear.coffee $PROJ/src/

coffee -b -j $PROJ/sysobject/enforce.core.js -c $ENF/lib/*.coffee
coffee -b -o $PROJ/usrobject -c $PROJ/src/*.coffee
